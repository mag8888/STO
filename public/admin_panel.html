<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Marketing Admin</title>
    <link rel="stylesheet" href="/style.css">
    <!-- Ionicons for Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>

<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <ion-icon name="paper-plane"></ion-icon>
            <span>TeleMarketing</span>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" onclick="switchView('dashboard')">
                    <ion-icon name="grid-outline"></ion-icon> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('inbox')">
                    <ion-icon name="chatbubbles-outline"></ion-icon> Inbox
                    <!-- <span class="badge blue">3</span> -->
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchToDirect()">
                    <ion-icon name="chatbox-ellipses-outline"></ion-icon> Direct
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('leads')">
                    <ion-icon name="people-outline"></ion-icon> Leads
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('broadcasts')">
                    <ion-icon name="megaphone-outline"></ion-icon> Broadcasts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('scout')">
                    <ion-icon name="telescope-outline"></ion-icon> Scout üî≠
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('kb')">
                    <ion-icon name="library-outline"></ion-icon> Knowledge Base
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('templates')">
                    <ion-icon name="document-text-outline"></ion-icon> Templates
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" onclick="switchView('settings')">
                    <ion-icon name="settings-outline"></ion-icon> Settings
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('triggers')">
                    <ion-icon name="ban-outline"></ion-icon> Triggers üö´
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('rules')">
                    <ion-icon name="bulb-outline"></ion-icon> Rules üß†
                </a>
            </li>
        </ul>

        <div class="status-indicator">
            <span class="status-dot" id="system-status-dot"></span> <span id="system-status-text">Checking...</span>
            <div id="auth-section" style="margin-top: 10px; display: none;">
                <button class="btn btn-primary" style="width: 100%; font-size: 0.8rem;" onclick="startAuthFlow()">Login
                    / Scan QR</button>
            </div>
            <div id="reconnect-section" style="margin-top: 10px; display: none;">
                <button class="btn btn-primary" style="width: 100%; font-size: 0.8rem;" onclick="reconnect()">Reconnect
                    üîÑ</button>
            </div>
            <div id="user-info"
                style="margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary); display: none;">
                Logged in as: <span id="username-display" style="color: var(--primary);">...</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view-container active">
            <div class="view-header">
                <h1 class="view-title">Overview</h1>
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn btn-secondary" onclick="syncChats()" title="Sync Telegram Chats">
                        <ion-icon name="sync-outline"></ion-icon> Sync
                    </button>
                    <button class="btn btn-secondary" onclick="switchToDirect()" title="Force Direct View">
                        See Direct
                    </button>
                    <button class="btn btn-primary" onclick="refreshStats()">Refresh</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="stat-leads-count">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Messages Sent</div>
                    <div class="stat-value" id="stat-msg-sent">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Dialogues</div>
                    <div class="stat-value" id="stat-active-dialogues">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending Drafts</div>
                    <div class="stat-value" id="stat-pending-drafts">-</div>
                </div>
            </div>

            <!-- Recent Activity Table Placeholder -->
            <div class="stat-card">
                <div class="stat-label">System Logs (Recent)</div>
                <div style="color: var(--text-secondary); margin-top: 1rem; font-family: monospace;" id="mini-logs">
                    Loading logs...
                </div>
            </div>
        </div>

        <!-- Inbox View -->
        <div id="inbox-view">
            <div class="chat-list-panel">
                <div class="chat-list-header" style="display:flex; gap:0.5rem;">
                    <input type="text" class="search-input" placeholder="Search chats..." id="chat-search"
                        onkeyup="renderChatList(dialogues)" style="flex:1; width:auto;">
                    <button class="btn btn-secondary" onclick="syncChats()" title="Sync Telegram Chats"
                        style="padding:0.5rem;">
                        <ion-icon name="sync-outline"></ion-icon>
                    </button>
                    <button class="btn btn-primary" onclick="openScoutModal()" title="Add New Chat"
                        style="padding:0.5rem 0.8rem; font-weight:bold;">
                        +
                    </button>
                </div>
                <!-- Filter Tabs -->
                <div
                    style="display:flex; gap:0.5rem; padding:0.5rem 1rem; border-bottom:1px solid var(--border); background:var(--bg-card);">
                    <div id="tab-all" class="filter-tab active" onclick="setFilter('ALL')"
                        style="flex:1; padding:0.3rem; text-align:center; border-radius:0.4rem; font-size:0.75rem; cursor:pointer; background:var(--primary); color:white;">
                        All</div>
                    <div id="tab-inbound" class="filter-tab" onclick="setFilter('INBOUND')"
                        style="flex:1; padding:0.3rem; text-align:center; border-radius:0.4rem; font-size:0.75rem; cursor:pointer; background:var(--bg-body); border:1px solid var(--border); color:var(--text-secondary);">
                        Direct</div>
                    <div id="tab-scout" class="filter-tab" onclick="setFilter('SCOUT')"
                        style="flex:1; padding:0.3rem; text-align:center; border-radius:0.4rem; font-size:0.75rem; cursor:pointer; background:var(--bg-body); border:1px solid var(--border); color:var(--text-secondary);">
                        Scout</div>
                </div>
                <div class="chat-items" id="chat-list">
                    <!-- Chat Items Injected Here -->
                    <div style="padding:1rem; color: var(--text-secondary);">Loading chats...</div>
                </div>
            </div>

            <div class="chat-detail-panel">
                <div class="chat-header" id="chat-header">
                    <div style="flex:1;">
                        <div id="active-chat-name" style="font-weight:600;">Select a chat</div>
                        <div id="active-chat-status" style="font-size:0.8rem; color:var(--text-secondary);"></div>
                    </div>
                    <div id="chat-actions" style="display:flex; gap:0.5rem;">
                        <!-- Actions like Approve Draft -->
                    </div>
                    <div style="margin-left:1rem; border-left:1px solid var(--border); padding-left:1rem; display:flex; gap:0.5rem;"
                        id="lead-actions">
                        <button class="btn btn-secondary" onclick="updateUserStatus('LEAD')"
                            title="Mark as Interested">üî• Lead</button>
                        <button class="btn btn-secondary" onclick="updateUserStatus('REJECTED')"
                            title="Not Interested">üö´ Reject</button>
                    </div>
                </div>

                <div class="messages-area" id="messages-area" onscroll="handleScroll()">
                    <!-- Messages Injected Here -->
                </div>
                <button id="scroll-btn" class="btn btn-secondary"
                    style="position:absolute; bottom:80px; right:20px; z-index:100; display:none; border-radius:50%; width:40px; height:40px; justify-content:center; align-items:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                    onclick="scrollToBottom()">
                    <ion-icon name="arrow-down-outline" style="font-size:1.2rem;"></ion-icon>
                </button>

                <div class="input-area" style="position:relative;">
                    <div id="edit-indicator"
                        style="display:none; position:absolute; top:-30px; left:1rem; background:var(--bg-card); border:1px solid var(--primary); padding:0.2rem 0.5rem; border-radius:4px; font-size:0.8rem; align-items:center; gap:0.5rem;">
                        <span>Editing draft...</span>
                        <ion-icon name="close-circle" style="cursor:pointer;" onclick="cancelEdit()"></ion-icon>
                    </div>
                    <textarea class="message-input" placeholder="Type a message..." id="message-input" rows="3"
                        style="resize:none; padding: 0.5rem;" onkeypress="handleEnter(event)"></textarea>
                    <button class="btn btn-primary" onclick="sendManualMessage()"
                        style="height: fit-content; align-self: flex-end;">Send</button>
                </div>
            </div>
        </div>

        <!-- Leads View -->
        <div id="leads-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Leads Database</h1>
                <button class="btn btn-primary">Export CSV</button>
            </div>

            <!-- Scanner -->
            <div class="stat-card" style="margin-bottom: 1rem;">
                <h3><ion-icon name="scan-outline"></ion-icon> Scan External Chat</h3>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <input type="text" id="scan-input" class="message-input" placeholder="@username or t.me/link"
                        style="flex:1;">
                    <button class="btn btn-primary" onclick="scanChat()">Scan</button>
                </div>
                <div id="scan-results" style="margin-top: 1rem; display: none;">
                    <h4>Potential Leads Found:</h4>
                    <div id="scan-list"
                        style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto; margin-top: 0.5rem;">
                    </div>
                </div>
            </div>

            <div class="stat-card" style="padding: 0; overflow: hidden;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Status</th>
                            <th>Tags</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="leads-table-body">
                        <!-- Leads injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Broadcasts View -->
        <div id="broadcasts-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Campaigns</h1>
                <button class="btn btn-primary">New Campaign</button>
            </div>
            <div class="stat-card">
                <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                    Broadcast functionality coming soon.
                </p>
            </div>
        </div>

        <!-- Scout View -->
        <div id="scout-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Scout External Chats üî≠</h1>
            </div>

            <div class="stat-card">
                <h3>Target Chat</h3>
                <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:1rem;">
                    Enter a public chat link (e.g. t.me/freelance_chat) to scan for leads matching keywords: "–∏—â—É",
                    "need", "–∫–ª–∏–µ–Ω—Ç", etc.
                </p>
                <div style="display:flex; gap:1rem; flex-wrap:wrap; display:none;">
                    <input type="text" id="scout-link" class="message-input" style="flex:1; min-width:200px;"
                        placeholder="https://t.me/example_chat">
                    <input type="number" id="scout-limit" class="message-input" style="width:100px;" value="50" min="10"
                        max="200">
                    <button class="btn btn-primary" onclick="scanChat()">Scan Now</button>
                </div>
                <div style="margin-top:1rem; color:var(--text-secondary); font-size:0.9rem;">
                    To add a new chat or scan a link, use the <b>+</b> button in the sidebar header (above).
                </div>
            </div>

            <div id="scout-results-area" style="margin-top:1rem; display:none;">
                <h3 style="margin-bottom:1rem;">Found Leads <span id="scout-count" class="badge">0</span></h3>
                <div id="scout-list"
                    style="display:grid; gap:1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                    <!-- Cards injected here -->
                </div>
            </div>
        </div>

        <!-- Templates View (Placeholder) -->
        <div id="templates-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Follow-up Templates</h1>
                <button class="btn btn-primary" onclick="loadTemplates()">Reload</button>
            </div>
            <div id="templates-list"
                style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                <!-- Templates injected here -->
            </div>
        </div>

        <!-- Triggers View -->
        <div id="triggers-view" class="view-container" style="display:none;">
            <div class="header">
                <h1>Ignore Triggers üö´</h1>
                <!-- <button class="btn btn-primary" onclick="openAddTriggerModal()">+ Add Trigger</button> -->
            </div>

            <div class="card">
                <h3>Add New Trigger</h3>
                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <input type="text" id="trigger-keyword" class="search-input"
                        placeholder="Keyword or Username to ignore..." style="flex:1;">
                    <select id="trigger-type" class="search-input" style="width:150px;">
                        <option value="KEYWORD">Keyword</option>
                        <option value="USERNAME">Username</option>
                    </select>
                    <button class="btn btn-primary" onclick="addTrigger()">Add</button>
                </div>
            </div>

            <div class="card" style="margin-top:2rem;">
                <h3>Active Triggers</h3>
                <div id="triggers-list" style="margin-top:1rem; display:flex; flex-wrap:wrap; gap:1rem;">
                    <!-- Triggers will be loaded here -->
                    <div style="padding:1rem; color:var(--text-secondary);">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Rules View -->
        <div id="rules-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Smart Rules üß†</h1>
                <button class="btn btn-primary" onclick="openAddRuleModal()">+ Add Rule</button>
            </div>

            <div class="stat-card" style="margin-bottom:1rem;">
                <p style="color:var(--text-secondary);">
                    Rules allow you to persistent instructions for the AI. <br>
                    <strong>Global Rules</strong> apply to ALL chats.<br>
                    <strong>Personal Rules</strong> apply only to specific users (save them from the chat prompt).
                </p>
            </div>

            <div id="rules-list" style="display: flex; flex-direction:column; gap:1rem;">
                <!-- Rules injected here -->
            </div>
        </div>

        <!-- Knowledge Base View -->
        <div id="kb-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Knowledge Base</h1>
                <button class="btn btn-primary" onclick="createKBItem()">+ Add Item</button>
            </div>

            <div style="display:flex; gap:1rem; height: 100%;">
                <!-- Active Items -->
                <div style="flex:2; overflow-y:auto;">
                    <h3>Active Q&A</h3>
                    <div id="kb-list" style="margin-top:1rem; display: flex; flex-direction:column; gap:1rem;">
                        <!-- KB Items -->
                    </div>
                </div>

                <!-- Learning Queue -->
                <div style="flex:1; background: var(--bg-card); padding:1rem; border-radius:1rem; overflow-y:auto;">
                    <h3>Learning Queue</h3>
                    <p style="font-size:0.8rem; color: var(--text-secondary); margin-bottom:1rem;">
                        Candidates from operator replies.
                    </p>
                    <div id="learning-list" style="display: flex; flex-direction:column; gap:1rem;">
                        <!-- Candidates -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">System Settings</h1>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Browser Session</div>
                    <div style="margin-top: 1rem;">
                        <div id="login-status-text" style="margin-bottom: 1rem;">Checking status...</div>
                        <img id="qr-code-img" style="max-width: 200px; display: none; border-radius: 0.5rem;" />
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="refreshLoginStatus()">Check
                        Login</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Coach Modal -->
    <div id="coach-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:var(--bg-card); padding:2rem; border-radius:1rem; width:500px; max-width:90%;">
            <h3 style="margin-top:0;">üë®‚Äçüè´ Coach the Assistant</h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">
                Explain what was wrong with this draft or provide a rule for the future.
            </p>
            <textarea id="coach-input"
                style="width:100%; height:100px; padding:0.5rem; border-radius:0.5rem; background:var(--bg-main); border:1px solid var(--border); color:var(--text-main); margin-bottom:1rem;"
                placeholder="e.g. Don't be so pushy, ask about their business first..."></textarea>
            <div style="display:flex; justify-content:flex-end; gap:1rem;">
                <button class="btn" onclick="closeCoachModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeedback()">Save Feedback</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let dialogues = [];
        let currentDialogueId = null;

        console.log('Admin Panel Loaded. Sync Button check:', !!document.querySelector('button[onclick="syncChats()"]'));

        // --- Navigation ---
        function switchView(viewId) {
            // Hide all views
            document.querySelectorAll('.view-container, #inbox-view').forEach(el => {
                el.classList.remove('active');
                if (el.id === 'inbox-view') el.style.display = 'none';
            });

            // Handle Direct View (Reuses Inbox)
            if (viewId === 'direct') {
                const inbox = document.getElementById('inbox-view');
                inbox.style.display = 'flex';
                inbox.classList.add('active');
                // Force filter
                currentFilter = 'INBOUND'; // Explicitly set variable
                setFilter('INBOUND');
                console.log('Switched to Direct. Filter set to:', currentFilter);
                // alert('Direct View Loaded. Filter: ' + currentFilter); 
                loadDialogues();

                // Update Nav link
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                document.querySelector(`.nav-link[onclick="switchView('${viewId}')"]`).classList.add('active');
                return;
            }

            // Show selected view
            const target = document.getElementById(viewId + '-view');
            if (!target) return; // Safety check

            if (viewId === 'inbox') {
                target.style.display = 'flex';
                setFilter('ALL'); // Default to ALL for inbox
                loadDialogues();
            } else {
                target.style.display = 'block';
            }

            target.classList.add('active');

            // Rules/Triggers loaders
            if (viewId === 'rules') loadRules();
            if (viewId === 'triggers') loadTriggers();

            // Update Nav link
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="switchView('${viewId}')"]`).classList.add('active');
        }

        // --- Dashboard Stats ---
        async function refreshStats() {
            try {
                // Fetch stats from backend (using existing endpoints or new ones)
                const res = await fetch('/dialogues');
                const data = await res.json();

                document.getElementById('stat-active-dialogues').textContent = data.length || 0;

                // Calculate drafts
                let drafts = 0;
                let sent = 0;
                data.forEach(d => {
                    const lastMsg = d.messages[0];
                    if (lastMsg && lastMsg.status === 'DRAFT') drafts++;

                    d.messages.forEach(m => {
                        if (m.sender === 'OPERATOR' || m.sender === 'SIMULATOR') sent++;
                    });
                });
                document.getElementById('stat-pending-drafts').textContent = drafts;
                document.getElementById('stat-msg-sent').textContent = sent; // Approximate
                document.getElementById('stat-leads-count').textContent = data.length; // Approximate leads as dialogues for now

                // Fetch Logs
                const logsRes = await fetch('/logs');
                const logs = await logsRes.json();
                const logsContainer = document.getElementById('mini-logs');
                if (logs.length > 0) {
                    logsContainer.innerHTML = logs.map(l => `<div style="margin-bottom:0.25rem;">${l}</div>`).join('');
                } else {
                    logsContainer.textContent = 'No recent logs.';
                }
            } catch (e) {
                console.error("Stats error", e);
                document.getElementById('mini-logs').textContent = 'Failed to load stats/logs.';
            }
        }

        // --- Inbox Logic ---
        let currentFilter = 'ALL';

        function setFilter(type) {
            currentFilter = type;

            // Update UI
            document.querySelectorAll('.filter-tab').forEach(el => {
                el.style.background = 'var(--bg-body)';
                el.style.color = 'var(--text-secondary)';
                el.style.borderColor = 'var(--border)';
                el.classList.remove('active');
            });

            const activeTab = document.getElementById(type === 'ALL' ? 'tab-all' : (type === 'SCOUT' ? 'tab-scout' : 'tab-inbound'));
            if (activeTab) {
                activeTab.style.background = 'var(--primary)';
                activeTab.style.color = 'white';
                activeTab.style.borderColor = 'var(--primary)';
                activeTab.classList.add('active');
            }

            renderChatList(dialogues);
        }

        // --- Special Direct View Handler ---
        function switchToDirect() {
            console.log('--- FORCING DIRECT VIEW ---');

            // 1. Hide all views
            document.querySelectorAll('.view-container, #inbox-view').forEach(el => {
                el.classList.remove('active');
                if (el.id === 'inbox-view') el.style.display = 'none';
            });

            // 2. Show Inbox View (reused)
            const inbox = document.getElementById('inbox-view');
            inbox.style.display = 'flex';
            inbox.classList.add('active');

            // 3. Set Filter & Logic
            currentFilter = 'INBOUND';
            // setFilter('INBOUND'); // setFilter calls render, but maybe not load?
            // Let's manually set active tab to avoid recursion if setFilter calls switchView? Unlikely.
            document.querySelectorAll('.filter-tab').forEach(el => el.classList.remove('active'));
            const tab = document.getElementById('tab-inbound');
            if (tab) tab.classList.add('active');

            console.log('Direct Filter Set:', currentFilter);

            // 5. Load Data
            loadDialogues();

            // 6. Update Sidebar
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const directLink = Array.from(document.querySelectorAll('.nav-link')).find(el => el.innerText.includes('Direct'));
            if (directLink) directLink.classList.add('active');
        }

        async function loadDialogues() {
            try {
                const res = await fetch('/dialogues');
                const data = await res.json();
                dialogues = data;
                renderChatList(data);
            } catch (e) {
                console.error("Failed to load dialogues", e);
            }
        }

        async function syncChats() {
            const btn = document.querySelector('button[onclick="syncChats()"]');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<ion-icon name="hourglass-outline"></ion-icon>';
            }
            try {
                method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limit: 100 })
            });
            if (res.ok) {
                const data = await res.json();
                alert(data.message || 'Sync complete');
                await loadDialogues();
            } else {
                const err = await res.json();
                alert('Sync failed: ' + (err.error || 'Unknown error'));
            }
        } catch (e) {
            console.error(e);
            alert('Sync error');
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<ion-icon name="sync-outline"></ion-icon>';
            }
        }
        }

        function renderChatList(fullList) {
            console.log('Rendering Chat List. Filter:', currentFilter);
            console.log('Full List Sample:', fullList.slice(0, 3));

            // 1. Filter by Search
            const search = document.getElementById('chat-search').value.toLowerCase();
            let list = fullList.filter(d => {
                const name = (d.user.firstName || '') + ' ' + (d.user.lastName || '');
                const username = d.user.username || '';
                return name.toLowerCase().includes(search) || username.toLowerCase().includes(search);
            });

            // 2. Filter by Type
            if (currentFilter !== 'ALL') {
                list = list.filter(d => {
                    // Check source field first, then fallback to sourceChatId
                    const isScout = d.source === 'SCOUT' || (d.user && d.user.sourceChatId);
                    if (currentFilter === 'SCOUT') return isScout;
                    if (currentFilter === 'INBOUND') return !isScout;
                    return true;
                });
            }
            const container = document.getElementById('chat-list');
            container.innerHTML = '';
            list.forEach(d => {
                const div = document.createElement('div');
                div.className = `chat-item ${d.id === currentDialogueId ? 'active' : ''}`;
                div.onclick = () => selectChat(d.id);

                const lastMsg = d.messages[0];
                const text = lastMsg ? lastMsg.text.substring(0, 30) + '...' : 'No messages';

                // Status Indicators
                let statusBadge = '';
                if (lastMsg && lastMsg.status === 'DRAFT') {
                    statusBadge = '<span class="badge badge-draft">DRAFT</span>';
                } else if (lastMsg && lastMsg.sender === 'USER') {
                    statusBadge = '<span class="badge badge-pending">PENDING</span>';
                }

                // Source Badge
                let sourceBadge = '';
                const isScout = d.source === 'SCOUT' || (d.user && d.user.sourceChatId);
                if (isScout) {
                    sourceBadge = '<span class="badge" style="background:#8e44ad;">SCOUT</span>';
                } else {
                    sourceBadge = '<span class="badge" style="background:#2ecc71;">DIRECT</span>';
                }

                div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <div style="font-weight:600;">
                        ${d.user.firstName || 'User'} 
                        <span style="font-size:0.8rem; color: #888;">@${d.user.username || d.user.telegramId}</span>
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem; margin-top:0.2rem;">
                    ${sourceBadge}
                    ${statusBadge}
                </div>
                <div style="font-size:0.85rem; color: #aaa; margin-top:0.25rem;">${text}</div>
                `;
                container.appendChild(div);
            });
        }

        async function selectChat(id) {
            currentDialogueId = id;

            // Highlight in list
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            // Find the element logic (simple refresh is easier but not efficient, let's just find by text or something?)
            // Actually renderChatList overwrites everything.
            // Let's just re-render to highlight? No, excessive.
            // Just assume renderChatList was called.

            // Re-render list to update active state
            renderChatList(dialogues);

            const d = dialogues.find(d => d.id === id);
            if (!d) return;

            document.getElementById('active-chat-name').textContent = d.user.firstName || d.user.username || 'User';

            // Status Indicator
            const statusEl = document.getElementById('active-chat-status');
            let statusText = `@${d.user.username || d.user.telegramId}`;
            if (d.user.status === 'LEAD') statusText += ' ‚Ä¢ üî• Lead';
            if (d.user.status === 'REJECTED') statusText += ' ‚Ä¢ üö´ Rejected';
            statusEl.textContent = statusText;

            // Show/Hide Lead Actions
            const actions = document.getElementById('lead-actions');
            if (actions) actions.style.display = 'flex';

            // Load messages
            const area = document.getElementById('messages-area');
            area.innerHTML = '<div style="padding:1rem;">Loading...</div>';

            // ... (rest of loadMessages logic, simplified for this snippet substitute)
            // Wait, I need to fetch active dialogue messages if I don't have them all?
            // The dialogue object in `dialogues` has messages (LIMIT 1 usually).
            // We need to fetch full history?
            // Existing code didn't seem to fetch full history on click?
            // Let's check `loadDialogues` implementation. It fetches `/dialogues`.
            // Does `/dialogues` return all messages?
            // Usually not.
            // But let's look at `renderMessages` which is likely missing or I implied it exists.

            // Actually, looking at original code, `selectChat` was barely implemented or I didn't see the full logic in the view.
            // Let's implement fetching messages.

            try {
                // Fetch full messages for this dialogue if needed, or just use what we have if backend returns enough.
                // Assuming we need to fetch more.
                // But for now, let's just use what's in `d.messages`. 
                // Wait, `loadDialogues` probably only returns snippet.
                // I should check `server.ts` endpoint `/dialogues`.
                renderMessages(d.messages);
            } catch (e) {
                area.innerHTML = 'Error loading messages';
            }

            //    } // Removed premature closing brace
            // Try to find element by onclick attribute or similar if needed, but for now just removing active class is enough.
            // Ideally we should add ID to chat-item div.

            // Fetch full details
            console.log('Fetching dialogue details for ID:', id);
            try {
                const res = await fetch(`/dialogues/${id}`);
                if (!res.ok) {
                    if (res.status === 404) {
                        // Chat likely archived or deleted
                        console.warn('Chat not found (might be archived)');
                        loadDialogues(); // Refresh list to remove stale entry
                        return;
                    }
                    throw new Error('Failed to load chat');
                }

                const dialogue = await res.json();

                if (!dialogue || !dialogue.user) {
                    console.error('Dialogue data incomplete', dialogue);
                    return;
                }

                renderChatHeader(dialogue);
                renderMessages(dialogue.messages);
            } catch (e) {
                console.error("Failed to load chat details", e);
                const area = document.getElementById('messages-area');
                area.innerHTML = '<div style="padding:1rem; color:red;">Failed to load chat.</div>';
            }
        }

        function renderChatHeader(dialogue) {
            const header = document.getElementById('active-chat-name');
            const statusEl = document.getElementById('active-chat-status');
            const user = dialogue.user;

            header.textContent = (user.firstName || '') + ' ' + (user.lastName || '') || user.username || 'User';

            // Status Indicator
            let statusText = `@${user.username || user.telegramId}`;
            if (user.status === 'LEAD') statusText += ' ‚Ä¢ üî• Lead';
            if (user.status === 'REJECTED') statusText += ' ‚Ä¢ üö´ Rejected';
            statusEl.textContent = statusText;

            // Show/Hide Lead Actions
            const actions = document.getElementById('lead-actions');
            if (actions) actions.style.display = 'flex';
        }

        function renderMessages(messages) {
            const area = document.getElementById('messages-area');
            area.innerHTML = '';

            if (!messages || messages.length === 0) {
                area.innerHTML = '<div style="padding:1rem; color:var(--text-secondary); text-align:center;">No messages yet.</div>';
                return;
            }

            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message-bubble ${msg.sender.toLowerCase()}`;
                if (msg.status === 'DRAFT') div.classList.add('draft');

                div.innerHTML = `<div style="white-space: pre-wrap;">${msg.text}</div>`;

                // Add timestamp if desired
                // div.innerHTML += `<div style="font-size:0.7rem; color:rgba(255,255,255,0.5); text-align:right; margin-top:0.2rem;">${new Date(msg.createdAt).toLocaleTimeString()}</div>`;

                area.appendChild(div);
            });

            scrollToBottom();
        }

        function startEditName(id, name, lastName) {
            // Implementation or stub
        }

        // --- Render Header (Fix) ---
        // I previously overwrote renderChatHeader and it got messy. 
        // Let's ensure renderChatHeader is clean and the HTML template is inside it correctly.
        // Wait, the previous view showed lines 672+ having raw HTML outside of any function and outside of quotes!
        // That is the syntax error.

        // Let's redefine renderChatHeader properly using innerHTML
        function renderChatHeader(dialogue) {
            const header = document.getElementById('active-chat-name');
            const statusEl = document.getElementById('active-chat-status');
            const user = dialogue.user;
            const name = user.firstName || 'Unknown';
            const lastName = user.lastName || '';
            const fullName = (name + ' ' + lastName).trim();
            const username = user.username ? `@${user.username}` : '';

            // Update the dedicated name element if we want to keep the new structure
            // But valid HTML was inserted into `active-chat-name` in previous attempts?
            // No, my previous edit targeted `active-chat-name`'s textContent.
            // If I want to add "Edit" or "Block" buttons, I should put them in `chat-actions` or similar.
            // The simple version just set textContent.

            // Source Badge & Move Button logic inside header
            let typeBadge = '';
            let moveBtn = '';

            const isScout = dialogue.source === 'SCOUT' || (dialogue.user && dialogue.user.sourceChatId);

            if (isScout) {
                typeBadge = '<span class="badge" style="background:#8e44ad; margin-left:0.5rem;">SCOUT</span>';
                moveBtn = `<button class="btn btn-secondary" style="font-size:0.7rem; padding:0.2rem 0.5rem; margin-left:0.5rem;" onclick="updateDialogueSource(${dialogue.id}, 'INBOUND')" title="Move to Direct">To Direct</button>`;
            } else {
                typeBadge = '<span class="badge" style="background:#2ecc71; margin-left:0.5rem;">DIRECT</span>';
                moveBtn = `<button class="btn btn-secondary" style="font-size:0.7rem; padding:0.2rem 0.5rem; margin-left:0.5rem;" onclick="updateDialogueSource(${dialogue.id}, 'SCOUT')" title="Move to Scout">To Scout</button>`;
            }

            header.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <div style="display:flex; align-items:center;">
                        <span style="font-weight:600;">${fullName}</span>
                        <span style="font-size:0.8em; color:var(--text-secondary); margin-left:0.5rem;">${username}</span>
                        ${typeBadge}
                        ${moveBtn}
                    </div>
                </div>
             `;

            // Update Status
            let statusText = '';
            if (user.status === 'LEAD') statusText = 'üî• Lead';
            if (user.status === 'REJECTED') statusText = 'üö´ Rejected';
            if (user.status === 'BLOCKED') statusText = '‚õî Blocked';
            statusEl.textContent = statusText;
            statusEl.style.display = statusText ? 'block' : 'none';

            // Show/Hide Lead Actions
            const actions = document.getElementById('lead-actions');
            if (actions) actions.style.display = 'flex';
        }

        async function archiveChat(id, skipConfirm = false) {
            if (!skipConfirm && !confirm('Hide this chat?')) return;
            try {
                await fetch(`/ dialogues / ${id}/archive`, { method: 'POST' });

                // Remove archived dialogue from local list
                dialogues = dialogues.filter(d => d.id !== id);

                // Find next chat to select
                if (dialogues.length > 0) {
                    selectChat(dialogues[0].id);
                } else {
                    currentDialogueId = null;
                    document.getElementById('active-chat-name').innerHTML = '<div style="color:var(--text-secondary);">No active chats</div>';
                    document.getElementById('messages-area').innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-secondary);">All caught up! üéâ</div>';
                    document.querySelector('.input-area').style.display = 'none';
                }

                renderDialoguesList(); // Refresh sidebar without full reload if possible, but loadDialogues is safer
                loadDialogues();
            } catch (e) {
                alert('Failed to archive');
            }
        }

        function startEditName(userId, currentFirst, currentLast) {
            const container = document.getElementById('active-chat-name');
            container.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <input type="text" id="edit-first-name" value="${currentFirst}" placeholder="First Name" style="padding:0.2rem; border-radius:4px; border:1px solid var(--border); width: 120px;">
                    <input type="text" id="edit-last-name" value="${currentLast}" placeholder="Last Name" style="padding:0.2rem; border-radius:4px; border:1px solid var(--border); width: 120px;">
                    <button class="btn btn-primary" style="padding:0.2rem 0.5rem; font-size:0.8rem;" onclick="saveName(${userId})">Save</button>
                    <button class="btn btn-secondary" style="padding:0.2rem 0.5rem; font-size:0.8rem;" onclick="selectChat(${currentDialogueId})">Cancel</button>
                </div>
            `;
        }

        async function saveName(userId) {
            const first = document.getElementById('edit-first-name').value;
            const last = document.getElementById('edit-last-name').value;

            try {
                await fetch(`/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName: first, lastName: last })
                });
                // Reload chat to update name
                selectChat(currentDialogueId);
                // Also reload list to update sidebar (optional, but good)
                loadDialogues();
            } catch (e) {
                alert('Failed to update name');
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages-area');
            const previousScrollTop = container.scrollTop;
            const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

            container.innerHTML = '';

            messages.forEach((m, index) => {
                const div = document.createElement('div');
                let type = 'received';
                if (m.status === 'DRAFT') type = 'draft';
                else if (m.sender === 'OPERATOR' || m.sender === 'SIMULATOR') type = 'sent';

                div.className = `message-bubble ${type}`;
                div.textContent = m.text;

                if (type === 'draft') {
                    const actionDiv = document.createElement('div');
                    actionDiv.style.marginTop = '0.5rem';
                    actionDiv.style.display = 'flex';
                    actionDiv.style.gap = '0.5rem';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-secondary';
                    editBtn.style.fontSize = '0.7rem';
                    editBtn.style.padding = '0.2rem 0.5rem';
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = () => editDraft(m.id, m.text);

                    const refineBtn = document.createElement('button');
                    refineBtn.className = 'btn btn-secondary';
                    refineBtn.style.fontSize = '0.7rem';
                    refineBtn.style.padding = '0.2rem 0.5rem';
                    refineBtn.innerHTML = '‚ú® Refine';
                    refineBtn.title = 'Regenerate with new instructions';
                    // Pass the text safely
                    refineBtn.onclick = () => openPromptModal(currentDialogueId, m.text);

                    const sendBtn = document.createElement('button');
                    sendBtn.className = 'btn btn-primary';
                    sendBtn.style.fontSize = '0.7rem';
                    sendBtn.style.padding = '0.2rem 0.5rem';
                    sendBtn.textContent = 'Send';
                    sendBtn.onclick = () => approveDraft(m.id, null);

                    actionDiv.appendChild(editBtn);
                    actionDiv.appendChild(refineBtn);
                    actionDiv.appendChild(sendBtn);
                    div.appendChild(actionDiv);
                }

                container.appendChild(div);
            });

            // "Generate Reply" & "Prompt" Button Logic
            const lastMsg = messages[messages.length - 1];
            if (lastMsg && lastMsg.sender === 'USER' && lastMsg.status === 'RECEIVED') {
                const div = document.createElement('div');
                div.style.textAlign = 'center';
                div.style.padding = '1rem';
                div.style.display = 'flex';
                div.style.gap = '1rem';
                div.style.justifyContent = 'center';
                div.innerHTML = `
                    <button id="regen-btn" class="btn btn-primary" onclick="regenerateDraft(${currentDialogueId}, this)">‚ö° Generate Reply</button>
                    <button id="prompt-btn" class="btn btn-secondary" onclick="openPromptModal(${currentDialogueId})">üìù Rules / Prompt</button>
                `;
                container.appendChild(div);
            } else if (messages.length === 0) {
                // Empty chat? Maybe show start button?
            }

            if (isAtBottom) {
                container.scrollTop = container.scrollHeight;
                hideScrollBtn();
            } else {
                container.scrollTop = previousScrollTop;
                showScrollBtn();
            }
        }

        // --- Editing State ---
        let editingMessageId = null;

        function cancelEdit() {
            editingMessageId = null;
            document.getElementById('message-input').value = '';
            document.getElementById('edit-indicator').style.display = 'none';
            document.querySelector('.input-area button').textContent = 'Send';
        }

        async function editDraft(msgId, currentText) {
            editingMessageId = msgId;
            const input = document.getElementById('message-input');
            input.value = currentText;
            input.focus();

            // Show indicator
            const indicator = document.getElementById('edit-indicator');
            if (indicator) {
                indicator.style.display = 'flex';
                indicator.querySelector('span').textContent = `Editing draft #${msgId}`;
            }

            document.querySelector('.input-area button').textContent = 'Send Draft';
        }

        async function approveDraft(msgId, updatedText) {
            try {
                const body = updatedText ? { updatedText } : {};
                const res = await fetch(`/messages/${msgId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const json = await res.json();
                if (json.id) {
                    if (currentDialogueId) selectChat(currentDialogueId);
                } else {
                    alert('Error: ' + JSON.stringify(json));
                }
            } catch (e) {
                alert('Failed to approve');
            }
        }

        async function sendManualMessage() {
            const text = document.getElementById('message-input').value;
            if (!currentDialogueId || !text) return;

            // Handle Draft Edit
            if (editingMessageId) {
                await approveDraft(editingMessageId, text);
                cancelEdit();
                return;
            }

            const dialogue = dialogues.find(d => d.id === currentDialogueId);
            const username = dialogue.user.username || dialogue.user.telegramId;

            try {
                await fetch('/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, message: text })
                });

                document.getElementById('message-input').value = '';
                setTimeout(loadDialogues, 2000);
            } catch (e) {
                alert('Failed to send');
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendManualMessage();
            }
        }

        // --- Feedback / Coach Logic ---
        let coachingMessageId = null;

        function openCoachModal(msgId, currentFeedback) {
            coachingMessageId = msgId;
            document.getElementById('coach-modal').style.display = 'flex';
            document.getElementById('coach-input').value = currentFeedback || '';
            document.getElementById('coach-input').focus();
        }

        function closeCoachModal() {
            document.getElementById('coach-modal').style.display = 'none';
            coachingMessageId = null;
        }

        async function saveFeedback() {
            const text = document.getElementById('coach-input').value;
            if (!coachingMessageId) return;

            try {
                const res = await fetch(`/messages/${coachingMessageId}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: text })
                });

                if (res.ok) {
                    closeCoachModal();
                    if (currentDialogueId) selectChat(currentDialogueId); // Refresh
                } else {
                    alert('Failed to save feedback');
                }
            } catch (e) {
                alert('Error generating template: ' + e.message);
            }
        }

        // --- Scout Logic ---
        async function scanChat(manualLink) {
            let link = manualLink;

            if (!link) {
                const multiInput = document.getElementById('scout-link');
                const scanInput = document.getElementById('scan-input'); // Backup
                if (multiInput) link = multiInput.value;
                else if (scanInput) link = scanInput.value;
            }

            const limit = document.getElementById('scout-limit')?.value || 50; // Optional safe access

            if (!link) {
                alert('Please enter a chat link');
                return;
            }

            // Button feedback (if button exists)
            const btn = document.querySelector('#scout-view .btn-primary');
            let originalText = '';
            if (btn) {
                originalText = btn.textContent;
                btn.textContent = 'Scanning... (this may take a while) ‚è≥';
                btn.disabled = true;
            }

            document.getElementById('scout-results-area').style.display = 'block';
            document.getElementById('scout-list').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem;">Scanning...</div>';

            try {
                // Extract username from link if possible, or send raw
                let username = link;
                if (link.includes('t.me/')) username = link.split('t.me/')[1].split('/')[0];
                if (username.startsWith('@')) username = username.substring(1);

                const res = await fetch('/scan-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatUsername: username, limit: parseInt(limit) })
                });

                if (!res.ok) throw new Error('Scan failed');

                const data = await res.json();
                renderScanResults(data.leads);

            } catch (e) {
                alert('Scan failed: ' + e.message);
                document.getElementById('scout-list').innerHTML = `<div style="color:red; text-align:center;">Error: ${e.message}</div>`;
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function renderScanResults(leads) {
            const container = document.getElementById('scout-list');
            document.getElementById('scout-count').textContent = leads.length;

            if (leads.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:var(--text-secondary);">No leads found matching keywords.</div>';
                return;
            }

            container.innerHTML = '';
            leads.forEach(lead => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.justifyContent = 'space-between';

                const sender = lead.sender;
                const name = sender.firstName || 'Unknown';
                const username = sender.username ? '@' + sender.username : 'ID: ' + sender.id;

                // Safe content
                const safeName = name.replace(/'/g, "\\'");
                // Escape only single quotes for onclick, keeping text mostly raw but safe
                const safeText = lead.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                card.innerHTML = `
                    <div>
                        <div style="font-weight:600; margin-bottom:0.2rem;">${name} <span style="font-weight:400; color:var(--text-secondary); font-size:0.8rem;">${username}</span></div>
                        <div style="font-size:0.9rem; color:var(--text-main); margin-bottom:1rem; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;">
                            ${lead.text}
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:100%;" 
                        onclick="startScoutedDialogue('${sender.id}', '${safeName}', \`${safeText}\`, '${sender.accessHash || ''}')">
                        Start Chat üí¨
                    </button>
                `;
                container.appendChild(card);
            });
        }

        async function startScoutedDialogue(usernameId, name, contextText, accessHash) {
            // Reuse existing logic, but ensure we send /scout/start
            // We need to implement /scout/start in server if not exists, OR just use /start-dialogue handling
            // The previous logic for leads-view (if any) used a similar approach.
            // Let's call a new endpoint or the standard one with extra context.

            try {
                const res = await fetch('/scout/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: usernameId,
                        name: name,
                        context: contextText,
                        accessHash: accessHash
                    })
                });

                const data = await res.json();
                if (data.dialogueId) {
                    switchView('inbox');
                    selectChat(data.dialogueId);
                } else {
                    alert('Failed to start chat');
                }
            } catch (e) {
                alert('Error starting chat: ' + e.message);
            }
        }

        async function regenerateDraft(dialogueId, btnElement) {
            console.log('Regenerating for ID:', dialogueId);

            // Use passed element or fallback to ID
            const btn = btnElement || document.getElementById('regen-btn');

            if (btn) {
                btn.textContent = 'Generating... ‚è≥';
                btn.disabled = true;
            } else {
                console.warn('Button element not found');
            }

            try {
                // alert('Sending request...'); // Debug alert
                const res = await fetch(`/dialogues/${dialogueId}/regenerate`, { method: 'POST' });
                if (!res.ok) throw new Error('Request failed: ' + res.status);

                if (btn) btn.textContent = 'Done! ‚úÖ';

                setTimeout(() => {
                    selectChat(dialogueId);
                }, 1000);
            } catch (e) {
                console.error(e);
                alert('Regeneration failed: ' + e.message);
                if (btn) {
                    btn.textContent = 'Retry ‚ö°';
                    btn.disabled = false;
                }
            }
        }

        // --- Init ---
        // Load initial data
        refreshStats();
        loadTemplates();

        // --- Knowledge Base Logic ---
        async function loadKB() {
            // Load Items
            try {
                const res = await fetch('/kb');
                const items = await res.json();
                const container = document.getElementById('kb-list');
                container.innerHTML = '';
                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                    <div style="font-weight:600; margin-bottom:0.5rem; color:var(--primary);">Q: ${item.question}</div>
                    <div style="color:var(--text-secondary);">A: ${item.answer}</div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) { console.error("KB Load error", e); }

            // Load Candidates
            try {
                const res = await fetch('/kb/candidates');
                const candidates = await res.json();
                const list = document.getElementById('learning-list');
                list.innerHTML = '';
                candidates.forEach(c => {
                    const div = document.createElement('div');
                    div.style.padding = '0.75rem';
                    div.style.border = '1px solid var(--border)';
                    div.style.borderRadius = '0.5rem';
                    div.innerHTML = `
                    <div style="font-size:0.85rem; margin-bottom:0.5rem;"><strong>Q:</strong> ${c.originalQuestion}</div>
                        <div style="font-size:0.85rem; color: var(--text-secondary); margin-bottom:0.5rem;"><strong>A:</strong> ${c.operatorAnswer}</div>
                        <button class="btn btn-primary" style="font-size:0.7rem; width:100%;" onclick="approveCandidate(${c.id})">Add to KB</button>
                    `;
                    list.appendChild(div);
                });
            } catch (e) { console.error("Candidates error", e); }
        }

        async function createKBItem() {
            const q = prompt("Question:");
            const a = prompt("Answer:");
            if (q && a) {
                await fetch('/kb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: q, answer: a })
                });
                loadKB();
            }
        }

        async function approveCandidate(id) {
            await fetch(`/kb/candidates/${id}/approve`, { method: 'POST' });
            loadKB();
        }

        // Add KB load to switchView
        const _origSwitchView = switchView;
        switchView = function (viewId) {
            _origSwitchView(viewId);
            if (viewId === 'kb') loadKB();
        }

        // Templates (Mock logic for now)
        async function loadTemplates() {
            const res = await fetch('/templates');
            const data = await res.json();
            const container = document.getElementById('templates-list');
            container.innerHTML = '';
            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `<div class="stat-label">${t.name}</div><div>${t.content}</div>`;
                container.appendChild(card);
            });
        }

        async function updateDialogueSource(id, newSource) {
            if (!confirm(`Move this chat to ${newSource}?`)) return;

            try {
                const res = await fetch(`/dialogues/${id}/source`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: newSource })
                });

                if (res.ok) {
                    // Update local data
                    const d = dialogues.find(x => x.id === id);
                    if (d) d.source = newSource;

                    // Refresh view
                    renderChatList(dialogues);
                    // Re-render header if it's the active chat
                    if (currentDialogueId === id) renderChatHeader(d);

                } else {
                    alert('Failed to update source');
                }
            } catch (e) {
                console.error(e);
                alert('Error updating source');
            }
        }

        async function updateUserStatus(newStatus) {
            if (!currentDialogueId) return;
            const d = dialogues.find(d => d.id === currentDialogueId);
            if (!d || !d.user) return;

            const userId = d.user.id;
            const originalStatus = d.user.status;

            // Optimistic Update
            d.user.status = newStatus;
            renderChatHeader(d);

            try {
                // 1. Update Status
                const res = await fetch(`/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!res.ok) throw new Error('Failed to update status');

                // 2. Auto-Ignore if Rejected
                if (newStatus === 'REJECTED') {
                    if (d.user.username) {
                        await fetch('/triggers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ keyword: d.user.username, type: 'USERNAME' })
                        });
                        console.log('Auto-ignored rejected user:', d.user.username);
                        if (document.getElementById('triggers-view').style.display === 'block') {
                            loadTriggers();
                        }
                    }
                }

                // Refresh list to update badges
                renderChatList(dialogues);

            } catch (e) {
                console.error("Status update error", e);
                alert('Failed to update status');
                d.user.status = originalStatus; // Revert
                renderChatHeader(d);
            }
        }

        async function blockUser(userId) {
            try {
                // 1. Block user
                await fetch(`/users/${userId}/block`, { method: 'POST' });

                // 2. Add to Ignore Triggers (Auto-Ignore)
                // Need to fetch user details first to get username
                // Or we can rely on `dialogues` array if available
                const d = dialogues.find(d => d.user.id === userId);
                if (d && d.user.username) {
                    await fetch('/triggers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ keyword: d.user.username, type: 'USERNAME' })
                    });
                    console.log('Auto-ignored blocked user:', d.user.username);
                    if (document.getElementById('triggers-view').style.display === 'block') {
                        loadTriggers();
                    }
                }

                if (currentDialogueId) archiveChat(currentDialogueId, true);
            } catch (e) {
                console.error('Failed to block/ignore', e);
            }
        }

        async function reconnect() {
            const btn = document.querySelector('#reconnect-section button');
            const originalText = btn.textContent;
            btn.textContent = 'Reconnecting...';
            btn.disabled = true;
            try {
                const res = await fetch('/reconnect', { method: 'POST' });
                if (res.ok) {
                    alert('Reconnection initiated. Wait for status to turn green.');
                    checkSystemStatus();
                } else {
                    alert('Failed to reconnect');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Login Status
        // Update checkSystemStatus to show reconnect button
        async function checkSystemStatus() {
            const dot = document.getElementById('system-status-dot');
            const text = document.getElementById('system-status-text');
            const authSection = document.getElementById('auth-section');
            const reconnectSection = document.getElementById('reconnect-section');
            const userInfo = document.getElementById('user-info');
            const usernameDisplay = document.getElementById('username-display');

            try {
                const res = await fetch('/status');
                const data = await res.json();

                if (data.connected) {
                    dot.className = 'status-dot green'; // Changed from style.background
                    text.textContent = 'Online';
                    authSection.style.display = 'none';
                    reconnectSection.style.display = 'none';
                    userInfo.style.display = 'block';
                    if (data.me) {
                        usernameDisplay.textContent = data.me.firstName || data.me.username || 'Me'; // Changed from 'User'
                    }
                } else {
                    dot.className = 'status-dot red'; // Changed from style.background
                    text.textContent = 'Disconnected';
                    authSection.style.display = 'block';
                    reconnectSection.style.display = 'block'; // Show reconnect
                    userInfo.style.display = 'none';
                }
            } catch (e) {
                // For now, prompt user to check terminal or implement QR flow if Puppeteer
                alert("Since we are using GramJS (Userbot), please check the server terminal for login prompts if not connected.");
            }
        }

        // Poll status
        setInterval(checkSystemStatus, 5000);
        checkSystemStatus();

        // Poll Messages & List
        setInterval(() => {
            if (currentDialogueId) {
                // We need a silent update to not disrupt typing or scrolling if possible, 
                // but for now simple refresh is valid to show new messages.
                // To avoid flickering, we might need smarter logic, but let's stick to simple first.
                // Actually, selectChat triggers full re-render. Ideally we just append. 
                // But full re-fetch is safer for consistency.
                const input = document.getElementById('message-input');
                const isTyping = input && document.activeElement === input;

                // Only refresh if not typing (or handle state better) - actually re-rendering messages area doesn't kill input focus usually if input is outside.
                // Input is outside messages-area. So it's fine.
                // But scroll position might jump. 
                // Let's just do it.
                selectChat(currentDialogueId);
            }
            loadDialogues();
        }, 3000);

        async function refreshLoginStatus() {
            const statusText = document.getElementById('login-status-text');
            const img = document.getElementById('qr-code-img');

            // Only update text if we're not already connected/polling successfully
            if (statusText.textContent !== 'Scan QR Code to Login') {
                statusText.textContent = 'Checking status...';
            }

            try {
                const res = await fetch('/login-qr');

                // Content-Type check to handle Image vs JSON
                const contentType = res.headers.get("content-type");

                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await res.json();
                    if (data.status === 'connected') {
                        statusText.textContent = "‚úÖ Connected & Authorized!";
                        statusText.className = "text-success"; // Assuming you have utility classes or styling
                        img.style.display = 'none';
                        if (qrInterval) clearInterval(qrInterval);
                        checkSystemStatus(); // Refresh global status
                    } else if (data.error) {
                        statusText.textContent = `Status: ${data.error}`;
                        if (res.status === 503) statusText.textContent = "Initializing client...";
                    }
                } else if (res.ok) {
                    // It's an image
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    img.src = url;
                    img.style.display = 'block';
                    statusText.textContent = 'Scan QR Code to Login';
                } else {
                    statusText.textContent = 'Error loading QR';
                }
            } catch (e) {
                console.error("QR Error", e);
                statusText.textContent = 'Connection error';
            }
        }


        // --- Scroll Logic ---
        function scrollToBottom() {
            const container = document.getElementById('messages-area');
            container.scrollTop = container.scrollHeight;
            hideScrollBtn();
        }

        function showScrollBtn() {
            const btn = document.getElementById('scroll-btn');
            if (btn) btn.style.display = 'flex';
        }

        function hideScrollBtn() {
            const btn = document.getElementById('scroll-btn');
            if (btn) btn.style.display = 'none';
        }

        function handleScroll() {
            const container = document.getElementById('messages-area');
            const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            if (isAtBottom) {
                hideScrollBtn();
            } else {
                showScrollBtn();
            }
        }

        // --- Scanner Logic ---
        async function scanChat() {
            const input = document.getElementById('scan-input');
            const link = input.value.trim();
            if (!link) return alert('Enter a link');

            // Find button by text content roughly or structure
            const btn = input.nextElementSibling;
            btn.textContent = 'Scanning...';
            btn.disabled = true;

            try {
                const res = await fetch('/scan-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatLink: link, limit: 100 })
                });
                const leads = await res.json();

                if (leads.error) throw new Error(leads.error);

                const container = document.getElementById('scan-list');
                container.innerHTML = '';
                document.getElementById('scan-results').style.display = 'block';

                if (leads.length === 0) {
                    container.innerHTML = '<div style="color:var(--text-secondary);">No keywords found in last 100 messages.</div>';
                }

                leads.forEach((lead, index) => {
                    const div = document.createElement('div');
                    div.style.padding = '0.75rem';
                    div.style.border = '1px solid var(--border)';
                    div.style.borderRadius = '0.5rem';
                    div.style.background = 'var(--bg-main)';
                    div.style.marginBottom = '0.5rem';

                    const name = lead.sender.firstName || 'Unknown';
                    const username = lead.sender.username ? `@${lead.sender.username}` : 'No username';

                    // Robust escaping
                    const safeText = lead.text
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '&quot;')
                        .replace(/\n/g, ' ');

                    const safeName = name
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\'");

                    const safeUsername = (lead.sender.username || lead.sender.id).toString();

                    const isLong = lead.text.length > 100;
                    const shortText = isLong ? lead.text.substring(0, 100) + '...' : lead.text;
                    // Escape for HTML display
                    const safeAccessHash = (lead.sender.accessHash || '');

                    const displayFull = lead.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const displayShort = shortText.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div style="flex:1; margin-right:1rem;">
                                <div style="font-weight:600;">${name} <span style="font-size:0.8rem; color:var(--text-secondary);">${username}</span></div>
                                
                                <div id="scan-text-${index}" style="margin-top:0.25rem; font-size:0.9rem; white-space: pre-wrap;">${displayShort}</div>
                                ${isLong ? `<a href="#" onclick="event.preventDefault(); toggleScanText(${index}, '${displayFull.replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${displayShort.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" id="scan-toggle-${index}" style="font-size:0.8rem; color:var(--primary);">Read more</a>` : ''}
                            </div>
                            <button class="btn btn-primary" style="font-size:0.7rem; white-space:nowrap;" onclick="startScoutedDialogue('${safeUsername}', '${safeName}', '${safeText.substring(0, 50)}', '${safeAccessHash}')">
                                Chat
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });

            } catch (e) {
                alert('Scan failed: ' + e.message);
            } finally {
                btn.textContent = 'Scan';
                btn.disabled = false;
            }
        }

        async function startScoutedDialogue(usernameId, name, contextText, accessHash) {
            try {
                const res = await fetch('/scout/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: usernameId,
                        name: name,
                        context: contextText,
                        accessHash: accessHash || undefined
                    })
                });
                const data = await res.json();
                if (data.dialogueId) {
                    loadDialogues(); // Refresh sidebar
                    setTimeout(() => selectChat(data.dialogueId), 500); // Open chat
                } else {
                    throw new Error(data.error || 'Failed to start chat');
                }
            } catch (e) {
                alert('Failed to start chat: ' + e.message);
            }
        }

        // --- Prompt / Rules Logic ---
        let promptDialogueId = null;

        function openPromptModal(id, targetText = null) {
            promptDialogueId = id;
            document.getElementById('prompt-input').value = '';
            document.getElementById('prompt-save-rule').checked = false; // Reset checkbox

            const targetContainer = document.getElementById('prompt-target-container');
            const targetEl = document.getElementById('prompt-target-text');

            if (targetText) {
                targetContainer.style.display = 'block';
                targetEl.textContent = targetText;
            } else {
                targetContainer.style.display = 'none';
            }

            document.getElementById('prompt-modal').style.display = 'flex';
            document.getElementById('prompt-input').focus();
        }

        function closePromptModal() {
            document.getElementById('prompt-modal').style.display = 'none';
            promptDialogueId = null;
        }

        async function submitPrompt() {
            const instructions = document.getElementById('prompt-input').value;
            const saveAsRule = document.getElementById('prompt-save-rule').checked;

            if (!instructions) return;

            const btn = document.querySelector('#prompt-modal .btn-primary');
            const originalText = btn.textContent;
            btn.textContent = 'Generating...';
            btn.disabled = true;

            try {
                // 1. Generate
                const res = await fetch(`/dialogues/${promptDialogueId}/regenerate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instructions })
                });

                // 2. Save Rule if checked
                if (saveAsRule) {
                    await fetch('/rules', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content: instructions,
                            isGlobal: false,
                            userId: dialogues.find(d => d.id === promptDialogueId)?.user?.id // Need user ID
                        })
                    });
                }

                if (res.ok) {
                    closePromptModal();
                    selectChat(promptDialogueId);
                } else {
                    const err = await res.json();
                    alert('Failed: ' + (err.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // --- Rules Logic ---
        async function loadRules() {
            try {
                const res = await fetch('/rules');
                const rules = await res.json();
                renderRules(rules);
            } catch (e) {
                console.error("Failed to load rules", e);
            }
        }

        function renderRules(rules) {
            const container = document.getElementById('rules-list');
            container.innerHTML = '';

            if (rules.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center;">No rules found.</div>';
                return;
            }

            rules.forEach(r => {
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';

                const typeBadge = r.isGlobal
                    ? '<span class="badge" style="background:#8e44ad;">GLOBAL</span>'
                    : '<span class="badge" style="background:#f39c12;">USER</span>';

                div.innerHTML = `
                    <div>
                        <div style="margin-bottom:0.5rem;">${typeBadge} <span style="font-size:0.8rem; color:var(--text-secondary);">${new Date(r.createdAt).toLocaleDateString()}</span></div>
                        <div style="font-size:1rem;">${r.content}</div>
                        ${r.userId ? `<div style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.2rem;">User ID: ${r.userId}</div>` : ''}
                    </div>
                    <button class="btn" style="color:var(--danger);" onclick="deleteRule(${r.id})"><ion-icon name="trash-outline"></ion-icon></button>
                `;
                container.appendChild(div);
            });
        }

        async function deleteRule(id) {
            if (!confirm('Delete this rule?')) return;
            try {
                await fetch(`/rules/${id}`, { method: 'DELETE' });
                loadRules();
            } catch (e) { alert('Failed to delete rule'); }
        }

        // --- Rules Logic (Modal) ---
        function openAddRuleModal() {
            document.getElementById('rule-modal').style.display = 'flex';
            const content = document.getElementById('rule-content');
            if (content) {
                content.value = '';
                content.focus();
            }
            const check = document.getElementById('rule-is-global');
            if (check) check.checked = true;
        }

        function closeRuleModal() {
            document.getElementById('rule-modal').style.display = 'none';
        }

        async function saveRule() {
            const content = document.getElementById('rule-content').value;
            const isGlobal = document.getElementById('rule-is-global').checked;

            if (!content) return;

            try {
                const btn = document.querySelector('#rule-modal .btn-primary');
                const origText = btn.textContent;
                btn.textContent = 'Saving...';
                btn.disabled = true;

                // Identify user if valid
                let userId = null;
                if (!isGlobal && currentDialogueId) {
                    const d = dialogues.find(d => d.id === currentDialogueId);
                    userId = d ? d.user.id : null;
                }

                await fetch('/rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        isGlobal: isGlobal,
                        userId: userId
                    })
                });
                closeRuleModal();
                loadRules();
                btn.textContent = origText;
                btn.disabled = false;
            } catch (e) {
                alert('Failed to save rule');
            }
        }

        // --- Triggers Logic ---
        async function loadTriggers() {
            const list = document.getElementById('triggers-list');
            try {
                const res = await fetch('/triggers');
                const triggers = await res.json();

                if (triggers.length === 0) {
                    list.innerHTML = '<div style="padding:1rem; color:var(--text-secondary);">No triggers found.</div>';
                    return;
                }

                list.innerHTML = triggers.map(t => `
                    <div style="background:var(--bg-card); padding:0.5rem 1rem; border-radius:30px; border:1px solid var(--border); display:flex; align-items:center; gap:0.5rem;">
                        <span style="color:var(--text-secondary); font-size:0.8rem;">[${t.type}]</span>
                        <span>${t.keyword}</span>
                        <button onclick="deleteTrigger(${t.id})" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">&times;</button>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = 'Error loading triggers';
            }
        }

        async function addTrigger() {
            const keyword = document.getElementById('trigger-keyword').value;
            const type = document.getElementById('trigger-type').value;

            if (!keyword) return;

            try {
                const res = await fetch('/triggers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, type })
                });
                if (res.ok) {
                    document.getElementById('trigger-keyword').value = '';
                    loadTriggers();
                } else {
                    alert('Failed to add trigger');
                }
            } catch (e) {
                alert('Error adding trigger');
            }
        }

        async function deleteTrigger(id) {
            if (!confirm('Remove this trigger?')) return;
            try {
                await fetch(`/triggers/${id}`, { method: 'DELETE' });
                loadTriggers();
            } catch (e) {
                alert('Failed to delete trigger');
            }
        }

        function openScoutModal() {
            const link = prompt("Enter @username or t.me/link to scan/add:");
            if (link) {
                // Determine if we are in Scout view or just want to add
                // We'll reuse scanChat logic
                scanChat(link);
                // Also switch to Scout view to see results
                switchView('scout');
            }
        }

        function toggleScanText(index, full, short) {
            const el = document.getElementById(`scan-text-${index}`);
            const link = document.getElementById(`scan-toggle-${index}`);
            if (el.dataset.state === 'short') {
                el.innerText = full;
                el.dataset.state = 'full';
                link.innerText = 'Read less';
            } else {
                el.innerText = short;
                el.dataset.state = 'short';
                link.innerText = 'Read more';
            }
        }

        // --- Init ---
        // Load initial data
        refreshStats();
        loadTemplates();

        // Add hook to switchView for Rules & Triggers
        const originalSwitchView = switchView;
        switchView = (viewId) => {
            // Hide all views
            document.querySelectorAll('.view-container, #inbox-view').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });

            // Show selected view
            const target = document.getElementById(viewId + '-view');
            // Check if target exists (triggers-view might be missing if not added yet, but we added it)
            if (target) {
                target.style.display = 'block'; // Default block
                if (viewId === 'inbox') {
                    target.style.display = 'flex';
                    setFilter('ALL'); // Default to ALL for inbox
                    loadDialogues();
                } else if (viewId === 'direct') {
                    // Reuse inbox view
                    const inbox = document.getElementById('inbox-view');
                    inbox.style.display = 'flex';
                    inbox.classList.add('active');
                    setFilter('INBOUND'); // Force INBOUND filter
                    loadDialogues();
                    target.style.display = 'none'; // Hide the 'direct-view' if it doesn't exist/empty
                } else if (viewId === 'rules') {
                    loadRules();
                } else if (viewId === 'triggers') {
                    loadTriggers();
                }
                target.classList.add('active');
            }

            // Update Nav link
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Try to match by onclick text or just ignore active state for now if complex
            // We used 'nav-item' class in HTML
            const navLink = document.querySelector(`.nav-item[onclick="switchView('${viewId}')"]`);
            if (navLink) navLink.classList.add('active');
        };

        // --- Auth Logic ---
        let qrInterval = null;

        function startAuthFlow() {
            // Switch to settings view so user can see the QR code area
            switchView('settings');
            // Trigger QR code refresh immediately
            refreshLoginStatus();

            // Start polling to keep QR fresh (GramJS rotates tokens)
            if (qrInterval) clearInterval(qrInterval);
            qrInterval = setInterval(refreshLoginStatus, 3000);
        }

        // Stop polling when connected
        const _origCheckStatus = checkSystemStatus;
        checkSystemStatus = async function () {
            await _origCheckStatus(); // Call original
            const text = document.getElementById('system-status-text').textContent;
            if (text === 'Online' && qrInterval) {
                clearInterval(qrInterval);
                qrInterval = null;
            }
        };

    </script>

    <!-- Rule Modal -->
    <div id="rule-modal" class="modal-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="background:var(--bg-card); padding:2rem; border-radius:12px; width:500px; border:1px solid var(--border);">
            <h3>Add Smart Rule üß†</h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">Rules help the AI understand how to behave.</p>

            <textarea id="rule-content" rows="4"
                style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid var(--border); background:var(--bg-main); color:var(--text-main); margin-bottom:1rem;"
                placeholder="e.g. Always be polite, never offer refunds..."></textarea>

            <div style="margin-bottom:1rem; display:flex; align-items:center;">
                <input type="checkbox" id="rule-is-global" checked style="margin-right:0.5rem;">
                <label for="rule-is-global" style="color:var(--text-secondary); font-size:0.9rem; cursor:pointer;">
                    Global Rule (Applies to everyone)
                </label>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                <button class="btn btn-secondary" onclick="closeRuleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRule()">Save Rule</button>
            </div>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div id="prompt-modal" class="modal-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="background:var(--bg-card); padding:2rem; border-radius:12px; width:500px; border:1px solid var(--border);">
            <h3>Regeneration Rules üß†</h3>

            <div id="prompt-target-container"
                style="margin-bottom:1rem; padding:0.5rem; background:var(--bg-secondary); border-left: 3px solid var(--primary); border-radius:4px; display:none;">
                <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.25rem;">Refining message:
                </div>
                <div id="prompt-target-text"
                    style="font-size:0.9rem; font-style:italic; max-height:100px; overflow-y:auto;"></div>
            </div>

            <p style="color:var(--text-secondary); margin-bottom:1rem;">Give specific instructions to the AI for this
                reply (e.g., "Be more casual", "Ask about budget").</p>
            <textarea id="prompt-input" rows="4"
                style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid var(--border); background:var(--bg-main); color:var(--text-main); margin-bottom:1rem;"
                placeholder="Enter instructions..."></textarea>

            <div style="margin-bottom:1rem; display:flex; align-items:center;">
                <input type="checkbox" id="prompt-save-rule" style="margin-right:0.5rem;">
                <label for="prompt-save-rule"
                    style="color:var(--text-secondary); font-size:0.9rem; cursor:pointer;">Save as <strong>Rule</strong>
                    for this client</label>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                <button class="btn btn-secondary" onclick="closePromptModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitPrompt()">Regenerate with Rules</button>
            </div>
        </div>
</body>

</html>