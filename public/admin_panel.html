<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Marketing Admin</title>
    <link rel="stylesheet" href="/style.css">
    <!-- Ionicons for Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>

<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <ion-icon name="paper-plane"></ion-icon>
            <span>TeleMarketing</span>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" onclick="switchView('dashboard')">
                    <ion-icon name="grid-outline"></ion-icon> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('inbox')">
                    <ion-icon name="chatbubbles-outline"></ion-icon> Inbox
                    <!-- <span class="badge blue">3</span> -->
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('leads')">
                    <ion-icon name="people-outline"></ion-icon> Leads
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('broadcasts')">
                    <ion-icon name="megaphone-outline"></ion-icon> Broadcasts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('scout')">
                    <ion-icon name="telescope-outline"></ion-icon> Scout üî≠
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('kb')">
                    <ion-icon name="library-outline"></ion-icon> Knowledge Base
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('templates')">
                    <ion-icon name="document-text-outline"></ion-icon> Templates
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('settings')">
                    <ion-icon name="settings-outline"></ion-icon> Settings
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('rules')">
                    <ion-icon name="bulb-outline"></ion-icon> Rules üß†
                </a>
            </li>
        </ul>

        <div class="status-indicator">
            <span class="status-dot" id="system-status-dot"></span> <span id="system-status-text">Checking...</span>
            <div id="auth-section" style="margin-top: 10px; display: none;">
                <button class="btn btn-primary" style="width: 100%; font-size: 0.8rem;" onclick="startAuthFlow()">Login
                    / Scan QR</button>
            </div>
            <div id="reconnect-section" style="margin-top: 10px; display: none;">
                <button class="btn btn-primary" style="width: 100%; font-size: 0.8rem;" onclick="reconnect()">Reconnect
                    üîÑ</button>
            </div>
            <div id="user-info"
                style="margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary); display: none;">
                Logged in as: <span id="username-display" style="color: var(--primary);">...</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view-container active">
            <div class="view-header">
                <h1 class="view-title">Overview</h1>
                <button class="btn btn-primary" onclick="refreshStats()">Refresh</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="stat-leads-count">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Messages Sent</div>
                    <div class="stat-value" id="stat-msg-sent">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Dialogues</div>
                    <div class="stat-value" id="stat-active-dialogues">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending Drafts</div>
                    <div class="stat-value" id="stat-pending-drafts">-</div>
                </div>
            </div>

            <!-- Recent Activity Table Placeholder -->
            <div class="stat-card">
                <div class="stat-label">System Logs (Recent)</div>
                <div style="color: var(--text-secondary); margin-top: 1rem; font-family: monospace;" id="mini-logs">
                    Loading logs...
                </div>
            </div>
        </div>

        <!-- Inbox View -->
        <div id="inbox-view">
            <div class="chat-list-panel">
                <div class="chat-list-header">
                    <input type="text" class="search-input" placeholder="Search chats..." id="chat-search">
                </div>
                <div class="chat-items" id="chat-list">
                    <!-- Chat Items Injected Here -->
                    <div style="padding:1rem; color: var(--text-secondary);">Loading chats...</div>
                </div>
            </div>

            <div class="chat-detail-panel">
                <div class="chat-header" id="chat-header">
                    <div id="active-chat-name">Select a chat</div>
                    <div id="chat-actions">
                        <!-- Actions like Approve Draft -->
                    </div>
                </div>

                <div class="messages-area" id="messages-area" onscroll="handleScroll()">
                    <!-- Messages Injected Here -->
                </div>
                <button id="scroll-btn" class="btn btn-secondary"
                    style="position:absolute; bottom:80px; right:20px; z-index:100; display:none; border-radius:50%; width:40px; height:40px; justify-content:center; align-items:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                    onclick="scrollToBottom()">
                    <ion-icon name="arrow-down-outline" style="font-size:1.2rem;"></ion-icon>
                </button>

                <div class="input-area" style="position:relative;">
                    <div id="edit-indicator"
                        style="display:none; position:absolute; top:-30px; left:1rem; background:var(--bg-card); border:1px solid var(--primary); padding:0.2rem 0.5rem; border-radius:4px; font-size:0.8rem; align-items:center; gap:0.5rem;">
                        <span>Editing draft...</span>
                        <ion-icon name="close-circle" style="cursor:pointer;" onclick="cancelEdit()"></ion-icon>
                    </div>
                    <textarea class="message-input" placeholder="Type a message..." id="message-input" rows="3"
                        style="resize:none; padding: 0.5rem;" onkeypress="handleEnter(event)"></textarea>
                    <button class="btn btn-primary" onclick="sendManualMessage()"
                        style="height: fit-content; align-self: flex-end;">Send</button>
                </div>
            </div>
        </div>

        <!-- Leads View -->
        <div id="leads-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Leads Database</h1>
                <button class="btn btn-primary">Export CSV</button>
            </div>

            <!-- Scanner -->
            <div class="stat-card" style="margin-bottom: 1rem;">
                <h3><ion-icon name="scan-outline"></ion-icon> Scan External Chat</h3>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <input type="text" id="scan-input" class="message-input" placeholder="@username or t.me/link"
                        style="flex:1;">
                    <button class="btn btn-primary" onclick="scanChat()">Scan</button>
                </div>
                <div id="scan-results" style="margin-top: 1rem; display: none;">
                    <h4>Potential Leads Found:</h4>
                    <div id="scan-list"
                        style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto; margin-top: 0.5rem;">
                    </div>
                </div>
            </div>

            <div class="stat-card" style="padding: 0; overflow: hidden;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Status</th>
                            <th>Tags</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="leads-table-body">
                        <!-- Leads injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Broadcasts View -->
        <div id="broadcasts-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Campaigns</h1>
                <button class="btn btn-primary">New Campaign</button>
            </div>
            <div class="stat-card">
                <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                    Broadcast functionality coming soon.
                </p>
            </div>
        </div>

        <!-- Scout View -->
        <div id="scout-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Scout External Chats üî≠</h1>
            </div>

            <div class="stat-card">
                <h3>Target Chat</h3>
                <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:1rem;">
                    Enter a public chat link (e.g. t.me/freelance_chat) to scan for leads matching keywords: "–∏—â—É",
                    "need", "–∫–ª–∏–µ–Ω—Ç", etc.
                </p>
                <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                    <input type="text" id="scout-link" class="message-input" style="flex:1; min-width:200px;"
                        placeholder="https://t.me/example_chat">
                    <input type="number" id="scout-limit" class="message-input" style="width:100px;" value="50" min="10"
                        max="200">
                    <button class="btn btn-primary" onclick="scanChat()">Scan Now</button>
                </div>
            </div>

            <div id="scout-results-area" style="margin-top:1rem; display:none;">
                <h3 style="margin-bottom:1rem;">Found Leads <span id="scout-count" class="badge">0</span></h3>
                <div id="scout-list"
                    style="display:grid; gap:1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                    <!-- Cards injected here -->
                </div>
            </div>
        </div>

        <!-- Templates View (Placeholder) -->
        <div id="templates-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Follow-up Templates</h1>
                <button class="btn btn-primary" onclick="loadTemplates()">Reload</button>
            </div>
            <div id="templates-list"
                style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                <!-- Templates injected here -->
            </div>
        </div>

        <!-- Rules View -->
        <div id="rules-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Smart Rules üß†</h1>
                <button class="btn btn-primary" onclick="openAddRuleModal()">+ Add Rule</button>
            </div>

            <div class="stat-card" style="margin-bottom:1rem;">
                <p style="color:var(--text-secondary);">
                    Rules allow you to persistent instructions for the AI. <br>
                    <strong>Global Rules</strong> apply to ALL chats.<br>
                    <strong>Personal Rules</strong> apply only to specific users (save them from the chat prompt).
                </p>
            </div>

            <div id="rules-list" style="display: flex; flex-direction:column; gap:1rem;">
                <!-- Rules injected here -->
            </div>
        </div>

        <!-- Knowledge Base View -->
        <div id="kb-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">Knowledge Base</h1>
                <button class="btn btn-primary" onclick="createKBItem()">+ Add Item</button>
            </div>

            <div style="display:flex; gap:1rem; height: 100%;">
                <!-- Active Items -->
                <div style="flex:2; overflow-y:auto;">
                    <h3>Active Q&A</h3>
                    <div id="kb-list" style="margin-top:1rem; display: flex; flex-direction:column; gap:1rem;">
                        <!-- KB Items -->
                    </div>
                </div>

                <!-- Learning Queue -->
                <div style="flex:1; background: var(--bg-card); padding:1rem; border-radius:1rem; overflow-y:auto;">
                    <h3>Learning Queue</h3>
                    <p style="font-size:0.8rem; color: var(--text-secondary); margin-bottom:1rem;">
                        Candidates from operator replies.
                    </p>
                    <div id="learning-list" style="display: flex; flex-direction:column; gap:1rem;">
                        <!-- Candidates -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="view-container">
            <div class="view-header">
                <h1 class="view-title">System Settings</h1>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Browser Session</div>
                    <div style="margin-top: 1rem;">
                        <div id="login-status-text" style="margin-bottom: 1rem;">Checking status...</div>
                        <img id="qr-code-img" style="max-width: 200px; display: none; border-radius: 0.5rem;" />
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="refreshLoginStatus()">Check
                        Login</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Coach Modal -->
    <div id="coach-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:var(--bg-card); padding:2rem; border-radius:1rem; width:500px; max-width:90%;">
            <h3 style="margin-top:0;">üë®‚Äçüè´ Coach the Assistant</h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">
                Explain what was wrong with this draft or provide a rule for the future.
            </p>
            <textarea id="coach-input"
                style="width:100%; height:100px; padding:0.5rem; border-radius:0.5rem; background:var(--bg-main); border:1px solid var(--border); color:var(--text-main); margin-bottom:1rem;"
                placeholder="e.g. Don't be so pushy, ask about their business first..."></textarea>
            <div style="display:flex; justify-content:flex-end; gap:1rem;">
                <button class="btn" onclick="closeCoachModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeedback()">Save Feedback</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let dialogues = [];
        let currentDialogueId = null;

        // --- Navigation ---
        function switchView(viewId) {
            // Hide all views
            document.querySelectorAll('.view-container, #inbox-view').forEach(el => {
                el.classList.remove('active');
                if (el.id === 'inbox-view') el.style.display = 'none';
            });

            // Show selected view
            const target = document.getElementById(viewId + '-view');
            if (viewId === 'inbox') {
                target.style.display = 'flex';
                // Reload dialogues when entering inbox
                loadDialogues();
            }
            target.classList.add('active');

            // Update Nav link
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="switchView('${viewId}')"]`).classList.add('active');
        }

        // --- Dashboard Stats ---
        async function refreshStats() {
            try {
                // Fetch stats from backend (using existing endpoints or new ones)
                const res = await fetch('/dialogues');
                const data = await res.json();

                document.getElementById('stat-active-dialogues').textContent = data.length || 0;

                // Calculate drafts
                let drafts = 0;
                let sent = 0;
                data.forEach(d => {
                    const lastMsg = d.messages[0];
                    if (lastMsg && lastMsg.status === 'DRAFT') drafts++;

                    d.messages.forEach(m => {
                        if (m.sender === 'OPERATOR' || m.sender === 'SIMULATOR') sent++;
                    });
                });
                document.getElementById('stat-pending-drafts').textContent = drafts;
                document.getElementById('stat-msg-sent').textContent = sent; // Approximate
                document.getElementById('stat-leads-count').textContent = data.length; // Approximate leads as dialogues for now

                // Fetch Logs
                const logsRes = await fetch('/logs');
                const logs = await logsRes.json();
                const logsContainer = document.getElementById('mini-logs');
                if (logs.length > 0) {
                    logsContainer.innerHTML = logs.map(l => `<div style="margin-bottom:0.25rem;">${l}</div>`).join('');
                } else {
                    logsContainer.textContent = 'No recent logs.';
                }
            } catch (e) {
                console.error("Stats error", e);
                document.getElementById('mini-logs').textContent = 'Failed to load stats/logs.';
            }
        }

        // --- Inbox Logic ---
        async function loadDialogues() {
            try {
                const res = await fetch('/dialogues');
                const data = await res.json();
                dialogues = data;
                renderChatList(data);
            } catch (e) {
                console.error("Failed to load dialogues", e);
            }
        }

        function renderChatList(list) {
            const container = document.getElementById('chat-list');
            container.innerHTML = '';
            list.forEach(d => {
                const div = document.createElement('div');
                div.className = `chat-item ${d.id === currentDialogueId ? 'active' : ''}`;
                div.onclick = () => selectChat(d.id);

                const lastMsg = d.messages[0];
                const text = lastMsg ? lastMsg.text.substring(0, 30) + '...' : 'No messages';

                // Status Indicators
                let statusBadge = '';
                if (lastMsg && lastMsg.status === 'DRAFT') {
                    statusBadge = '<span class="badge badge-draft">DRAFT</span>';
                } else if (lastMsg && lastMsg.sender === 'USER') {
                    statusBadge = '<span class="badge badge-pending">PENDING</span>';
                }

                // Source Badge
                let sourceBadge = '';
                if (d.source === 'SCOUT') {
                    sourceBadge = '<span class="badge" style="background:#8e44ad;">SCOUT</span>';
                } else {
                    sourceBadge = '<span class="badge" style="background:#2ecc71;">INBOUND</span>';
                }

                div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <div style="font-weight:600;">
                        ${d.user.firstName || 'User'} 
                        <span style="font-size:0.8rem; color: #888;">@${d.user.username || d.user.telegramId}</span>
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem; margin-top:0.2rem;">
                    ${sourceBadge}
                    ${statusBadge}
                </div>
                <div style="font-size:0.85rem; color: #aaa; margin-top:0.25rem;">${text}</div>
                `;
                container.appendChild(div);
            });
        }

        async function selectChat(id) {
            currentDialogueId = id;

            // Highlight in list
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            // Try to find element by onclick attribute or similar if needed, but for now just removing active class is enough.
            // Ideally we should add ID to chat-item div.

            // Fetch full details
            console.log('Fetching dialogue details for ID:', id);
            try {
                const res = await fetch(`/dialogues/${id}`);
                if (!res.ok) {
                    if (res.status === 404) {
                        // Chat likely archived or deleted
                        console.warn('Chat not found (might be archived)');
                        loadDialogues(); // Refresh list to remove stale entry
                        return;
                    }
                    throw new Error('Failed to load chat');
                }

                const dialogue = await res.json();

                if (!dialogue || !dialogue.user) {
                    console.error('Dialogue data incomplete', dialogue);
                    return;
                }

                renderChatHeader(dialogue);
                renderMessages(dialogue.messages);
            } catch (e) {
                console.error("Failed to load chat details", e);
            }
        }

        function renderChatHeader(dialogue) {
            const header = document.getElementById('active-chat-name'); // Use active-chat-name as per original structure
            const user = dialogue.user;
            const name = user.firstName || 'Unknown';
            const lastName = user.lastName || '';
            const fullName = [name, lastName].filter(Boolean).join(' ');
            const username = user.username ? `@${user.username}` : '';

            header.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span id="chat-title-text" style="font-weight:600;">${fullName}</span>
                        <span style="font-size:0.8em; color:var(--text-secondary);">${username}</span>
                        <button class="btn btn-secondary" style="padding:0.1rem 0.3rem; font-size:0.7rem;" onclick="startEditName(${user.id}, '${name.replace(/'/g, "\\'")}', '${lastName.replace(/'/g, "\\'")}')">
                            <ion-icon name="pencil-outline"></ion-icon>
                        </button>
                    </div>
                    <button class="btn" style="background:var(--bg-main); border:1px solid var(--border); color:var(--text-secondary); margin-left:0.5rem;" onclick="blockUser(${user.id})">Block üö´</button>
                    <button class="btn" style="background:var(--bg-main); border:1px solid var(--border); color:var(--text-secondary);" onclick="archiveChat(${dialogue.id})">Archive üóëÔ∏è</button>
                </div>
            `;
        }

        async function archiveChat(id, skipConfirm = false) {
            if (!skipConfirm && !confirm('Hide this chat?')) return;
            try {
                await fetch(`/dialogues/${id}/archive`, { method: 'POST' });

                // Remove archived dialogue from local list
                dialogues = dialogues.filter(d => d.id !== id);

                // Find next chat to select
                if (dialogues.length > 0) {
                    selectChat(dialogues[0].id);
                } else {
                    currentDialogueId = null;
                    document.getElementById('active-chat-name').innerHTML = '<div style="color:var(--text-secondary);">No active chats</div>';
                    document.getElementById('messages-area').innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-secondary);">All caught up! üéâ</div>';
                    document.querySelector('.input-area').style.display = 'none';
                }

                renderDialoguesList(); // Refresh sidebar without full reload if possible, but loadDialogues is safer
                loadDialogues();
            } catch (e) {
                alert('Failed to archive');
            }
        }

        function startEditName(userId, currentFirst, currentLast) {
            const container = document.getElementById('active-chat-name');
            container.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <input type="text" id="edit-first-name" value="${currentFirst}" placeholder="First Name" style="padding:0.2rem; border-radius:4px; border:1px solid var(--border); width: 120px;">
                    <input type="text" id="edit-last-name" value="${currentLast}" placeholder="Last Name" style="padding:0.2rem; border-radius:4px; border:1px solid var(--border); width: 120px;">
                    <button class="btn btn-primary" style="padding:0.2rem 0.5rem; font-size:0.8rem;" onclick="saveName(${userId})">Save</button>
                    <button class="btn btn-secondary" style="padding:0.2rem 0.5rem; font-size:0.8rem;" onclick="selectChat(${currentDialogueId})">Cancel</button>
                </div>
            `;
        }

        async function saveName(userId) {
            const first = document.getElementById('edit-first-name').value;
            const last = document.getElementById('edit-last-name').value;

            try {
                await fetch(`/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName: first, lastName: last })
                });
                // Reload chat to update name
                selectChat(currentDialogueId);
                // Also reload list to update sidebar (optional, but good)
                loadDialogues();
            } catch (e) {
                alert('Failed to update name');
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages-area');
            const previousScrollTop = container.scrollTop;
            const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

            container.innerHTML = '';

            messages.forEach((m, index) => {
                const div = document.createElement('div');
                let type = 'received';
                if (m.status === 'DRAFT') type = 'draft';
                else if (m.sender === 'OPERATOR' || m.sender === 'SIMULATOR') type = 'sent';

                div.className = `message-bubble ${type}`;
                div.textContent = m.text;

                if (type === 'draft') {
                    const actionDiv = document.createElement('div');
                    actionDiv.style.marginTop = '0.5rem';
                    actionDiv.style.display = 'flex';
                    actionDiv.style.gap = '0.5rem';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-secondary';
                    editBtn.style.fontSize = '0.7rem';
                    editBtn.style.padding = '0.2rem 0.5rem';
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = () => editDraft(m.id, m.text);

                    const refineBtn = document.createElement('button');
                    refineBtn.className = 'btn btn-secondary';
                    refineBtn.style.fontSize = '0.7rem';
                    refineBtn.style.padding = '0.2rem 0.5rem';
                    refineBtn.innerHTML = '‚ú® Refine';
                    refineBtn.title = 'Regenerate with new instructions';
                    // Pass the text safely
                    refineBtn.onclick = () => openPromptModal(currentDialogueId, m.text);

                    const sendBtn = document.createElement('button');
                    sendBtn.className = 'btn btn-primary';
                    sendBtn.style.fontSize = '0.7rem';
                    sendBtn.style.padding = '0.2rem 0.5rem';
                    sendBtn.textContent = 'Send';
                    sendBtn.onclick = () => approveDraft(m.id, null);

                    actionDiv.appendChild(editBtn);
                    actionDiv.appendChild(refineBtn);
                    actionDiv.appendChild(sendBtn);
                    div.appendChild(actionDiv);
                }

                container.appendChild(div);
            });

            // "Generate Reply" & "Prompt" Button Logic
            const lastMsg = messages[messages.length - 1];
            if (lastMsg && lastMsg.sender === 'USER' && lastMsg.status === 'RECEIVED') {
                const div = document.createElement('div');
                div.style.textAlign = 'center';
                div.style.padding = '1rem';
                div.style.display = 'flex';
                div.style.gap = '1rem';
                div.style.justifyContent = 'center';
                div.innerHTML = `
                    <button id="regen-btn" class="btn btn-primary" onclick="regenerateDraft(${currentDialogueId}, this)">‚ö° Generate Reply</button>
                    <button id="prompt-btn" class="btn btn-secondary" onclick="openPromptModal(${currentDialogueId})">üìù Rules / Prompt</button>
                `;
                container.appendChild(div);
            } else if (messages.length === 0) {
                // Empty chat? Maybe show start button?
            }

            if (isAtBottom) {
                container.scrollTop = container.scrollHeight;
                hideScrollBtn();
            } else {
                container.scrollTop = previousScrollTop;
                showScrollBtn();
            }
        }

        // --- Editing State ---
        let editingMessageId = null;

        function cancelEdit() {
            editingMessageId = null;
            document.getElementById('message-input').value = '';
            document.getElementById('edit-indicator').style.display = 'none';
            document.querySelector('.input-area button').textContent = 'Send';
        }

        async function editDraft(msgId, currentText) {
            editingMessageId = msgId;
            const input = document.getElementById('message-input');
            input.value = currentText;
            input.focus();

            // Show indicator
            const indicator = document.getElementById('edit-indicator');
            if (indicator) {
                indicator.style.display = 'flex';
                indicator.querySelector('span').textContent = `Editing draft #${msgId}`;
            }

            document.querySelector('.input-area button').textContent = 'Send Draft';
        }

        async function approveDraft(msgId, updatedText) {
            try {
                const body = updatedText ? { updatedText } : {};
                const res = await fetch(`/messages/${msgId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const json = await res.json();
                if (json.id) {
                    if (currentDialogueId) selectChat(currentDialogueId);
                } else {
                    alert('Error: ' + JSON.stringify(json));
                }
            } catch (e) {
                alert('Failed to approve');
            }
        }

        async function sendManualMessage() {
            const text = document.getElementById('message-input').value;
            if (!currentDialogueId || !text) return;

            // Handle Draft Edit
            if (editingMessageId) {
                await approveDraft(editingMessageId, text);
                cancelEdit();
                return;
            }

            const dialogue = dialogues.find(d => d.id === currentDialogueId);
            const username = dialogue.user.username || dialogue.user.telegramId;

            try {
                await fetch('/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, message: text })
                });

                document.getElementById('message-input').value = '';
                setTimeout(loadDialogues, 2000);
            } catch (e) {
                alert('Failed to send');
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendManualMessage();
            }
        }

        // --- Feedback / Coach Logic ---
        let coachingMessageId = null;

        function openCoachModal(msgId, currentFeedback) {
            coachingMessageId = msgId;
            document.getElementById('coach-modal').style.display = 'flex';
            document.getElementById('coach-input').value = currentFeedback || '';
            document.getElementById('coach-input').focus();
        }

        function closeCoachModal() {
            document.getElementById('coach-modal').style.display = 'none';
            coachingMessageId = null;
        }

        async function saveFeedback() {
            const text = document.getElementById('coach-input').value;
            if (!coachingMessageId) return;

            try {
                const res = await fetch(`/messages/${coachingMessageId}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: text })
                });

                if (res.ok) {
                    closeCoachModal();
                    if (currentDialogueId) selectChat(currentDialogueId); // Refresh
                } else {
                    alert('Failed to save feedback');
                }
            } catch (e) {
                alert('Error generating template: ' + e.message);
            }
        }

        // --- Scout Logic ---
        async function scanChat() {
            const link = document.getElementById('scout-link').value;
            const limit = document.getElementById('scout-limit').value || 50;
            if (!link) {
                alert('Please enter a chat link');
                return;
            }

            const btn = document.querySelector('#scout-view .btn-primary');
            const originalText = btn.textContent;
            btn.textContent = 'Scanning... (this may take a while) ‚è≥';
            btn.disabled = true;

            document.getElementById('scout-results-area').style.display = 'block';
            document.getElementById('scout-list').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem;">Scanning...</div>';

            try {
                // Extract username from link if possible, or send raw
                let username = link;
                if (link.includes('t.me/')) username = link.split('t.me/')[1].split('/')[0];
                if (username.startsWith('@')) username = username.substring(1);

                const res = await fetch('/scan-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatUsername: username, limit: parseInt(limit) })
                });

                if (!res.ok) throw new Error('Scan failed');

                const data = await res.json();
                renderScanResults(data.leads);

            } catch (e) {
                alert('Scan failed: ' + e.message);
                document.getElementById('scout-list').innerHTML = `<div style="color:red; text-align:center;">Error: ${e.message}</div>`;
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function renderScanResults(leads) {
            const container = document.getElementById('scout-list');
            document.getElementById('scout-count').textContent = leads.length;

            if (leads.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:var(--text-secondary);">No leads found matching keywords.</div>';
                return;
            }

            container.innerHTML = '';
            leads.forEach(lead => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.justifyContent = 'space-between';

                const sender = lead.sender;
                const name = sender.firstName || 'Unknown';
                const username = sender.username ? '@' + sender.username : 'ID: ' + sender.id;

                // Safe content
                const safeName = name.replace(/'/g, "\\'");
                // Escape only single quotes for onclick, keeping text mostly raw but safe
                const safeText = lead.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                card.innerHTML = `
                    <div>
                        <div style="font-weight:600; margin-bottom:0.2rem;">${name} <span style="font-weight:400; color:var(--text-secondary); font-size:0.8rem;">${username}</span></div>
                        <div style="font-size:0.9rem; color:var(--text-main); margin-bottom:1rem; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;">
                            ${lead.text}
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:100%;" 
                        onclick="startScoutedDialogue('${sender.id}', '${safeName}', \`${safeText}\`, '${sender.accessHash || ''}')">
                        Start Chat üí¨
                    </button>
                `;
                container.appendChild(card);
            });
        }

        async function startScoutedDialogue(usernameId, name, contextText, accessHash) {
            // Reuse existing logic, but ensure we send /scout/start
            // We need to implement /scout/start in server if not exists, OR just use /start-dialogue handling
            // The previous logic for leads-view (if any) used a similar approach.
            // Let's call a new endpoint or the standard one with extra context.

            try {
                const res = await fetch('/scout/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: usernameId,
                        name: name,
                        context: contextText,
                        accessHash: accessHash
                    })
                });

                const data = await res.json();
                if (data.dialogueId) {
                    switchView('inbox');
                    selectChat(data.dialogueId);
                } else {
                    alert('Failed to start chat');
                }
            } catch (e) {
                alert('Error starting chat: ' + e.message);
            }
        }

        async function regenerateDraft(dialogueId, btnElement) {
            console.log('Regenerating for ID:', dialogueId);

            // Use passed element or fallback to ID
            const btn = btnElement || document.getElementById('regen-btn');

            if (btn) {
                btn.textContent = 'Generating... ‚è≥';
                btn.disabled = true;
            } else {
                console.warn('Button element not found');
            }

            try {
                // alert('Sending request...'); // Debug alert
                const res = await fetch(`/dialogues/${dialogueId}/regenerate`, { method: 'POST' });
                if (!res.ok) throw new Error('Request failed: ' + res.status);

                if (btn) btn.textContent = 'Done! ‚úÖ';

                setTimeout(() => {
                    selectChat(dialogueId);
                }, 1000);
            } catch (e) {
                console.error(e);
                alert('Regeneration failed: ' + e.message);
                if (btn) {
                    btn.textContent = 'Retry ‚ö°';
                    btn.disabled = false;
                }
            }
        }

        // --- Init ---
        // Load initial data
        refreshStats();
        loadTemplates();

        // --- Knowledge Base Logic ---
        async function loadKB() {
            // Load Items
            try {
                const res = await fetch('/kb');
                const items = await res.json();
                const container = document.getElementById('kb-list');
                container.innerHTML = '';
                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                    <div style="font-weight:600; margin-bottom:0.5rem; color:var(--primary);">Q: ${item.question}</div>
                    <div style="color:var(--text-secondary);">A: ${item.answer}</div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) { console.error("KB Load error", e); }

            // Load Candidates
            try {
                const res = await fetch('/kb/candidates');
                const candidates = await res.json();
                const list = document.getElementById('learning-list');
                list.innerHTML = '';
                candidates.forEach(c => {
                    const div = document.createElement('div');
                    div.style.padding = '0.75rem';
                    div.style.border = '1px solid var(--border)';
                    div.style.borderRadius = '0.5rem';
                    div.innerHTML = `
                    <div style="font-size:0.85rem; margin-bottom:0.5rem;"><strong>Q:</strong> ${c.originalQuestion}</div>
                        <div style="font-size:0.85rem; color: var(--text-secondary); margin-bottom:0.5rem;"><strong>A:</strong> ${c.operatorAnswer}</div>
                        <button class="btn btn-primary" style="font-size:0.7rem; width:100%;" onclick="approveCandidate(${c.id})">Add to KB</button>
                    `;
                    list.appendChild(div);
                });
            } catch (e) { console.error("Candidates error", e); }
        }

        async function createKBItem() {
            const q = prompt("Question:");
            const a = prompt("Answer:");
            if (q && a) {
                await fetch('/kb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: q, answer: a })
                });
                loadKB();
            }
        }

        async function approveCandidate(id) {
            await fetch(`/kb/candidates/${id}/approve`, { method: 'POST' });
            loadKB();
        }

        // Add KB load to switchView
        const _origSwitchView = switchView;
        switchView = function (viewId) {
            _origSwitchView(viewId);
            if (viewId === 'kb') loadKB();
        }

        // Templates (Mock logic for now)
        async function loadTemplates() {
            const res = await fetch('/templates');
            const data = await res.json();
            const container = document.getElementById('templates-list');
            container.innerHTML = '';
            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `<div class="stat-label">${t.name}</div><div>${t.content}</div>`;
                container.appendChild(card);
            });
        }

        async function blockUser(userId) {
            // Instant block, no confirmation
            try {
                await fetch(`/users/${userId}/block`, { method: 'POST' });
                // alert('User blocked'); // Removed by request
                // Optional: Archive chat automatically
                if (currentDialogueId) archiveChat(currentDialogueId, true);
            } catch (e) {
                console.error('Failed to block', e);
            }
        }

        async function reconnect() {
            const btn = document.querySelector('#reconnect-section button');
            const originalText = btn.textContent;
            btn.textContent = 'Reconnecting...';
            btn.disabled = true;
            try {
                const res = await fetch('/reconnect', { method: 'POST' });
                if (res.ok) {
                    alert('Reconnection initiated. Wait for status to turn green.');
                    checkSystemStatus();
                } else {
                    alert('Failed to reconnect');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Login Status
        // Update checkSystemStatus to show reconnect button
        async function checkSystemStatus() {
            const dot = document.getElementById('system-status-dot');
            const text = document.getElementById('system-status-text');
            const authSection = document.getElementById('auth-section');
            const reconnectSection = document.getElementById('reconnect-section');
            const userInfo = document.getElementById('user-info');
            const usernameDisplay = document.getElementById('username-display');

            try {
                const res = await fetch('/status');
                const data = await res.json();

                if (data.connected) {
                    dot.className = 'status-dot green'; // Changed from style.background
                    text.textContent = 'Online';
                    authSection.style.display = 'none';
                    reconnectSection.style.display = 'none';
                    userInfo.style.display = 'block';
                    if (data.me) {
                        usernameDisplay.textContent = data.me.firstName || data.me.username || 'Me'; // Changed from 'User'
                    }
                } else {
                    dot.className = 'status-dot red'; // Changed from style.background
                    text.textContent = 'Disconnected';
                    authSection.style.display = 'block';
                    reconnectSection.style.display = 'block'; // Show reconnect
                    userInfo.style.display = 'none';
                }
            } catch (e) {
                // For now, prompt user to check terminal or implement QR flow if Puppeteer
                alert("Since we are using GramJS (Userbot), please check the server terminal for login prompts if not connected.");
            }
        }

        // Poll status
        setInterval(checkSystemStatus, 5000);
        checkSystemStatus();

        // Poll Messages & List
        setInterval(() => {
            if (currentDialogueId) {
                // We need a silent update to not disrupt typing or scrolling if possible, 
                // but for now simple refresh is valid to show new messages.
                // To avoid flickering, we might need smarter logic, but let's stick to simple first.
                // Actually, selectChat triggers full re-render. Ideally we just append. 
                // But full re-fetch is safer for consistency.
                const input = document.getElementById('message-input');
                const isTyping = input && document.activeElement === input;

                // Only refresh if not typing (or handle state better) - actually re-rendering messages area doesn't kill input focus usually if input is outside.
                // Input is outside messages-area. So it's fine.
                // But scroll position might jump. 
                // Let's just do it.
                selectChat(currentDialogueId);
            }
            loadDialogues();
        }, 3000);

        async function refreshLoginStatus() {
            const res = await fetch('/login-qr');
            if (res.ok) {
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const img = document.getElementById('qr-code-img');
                img.src = url;
                img.style.display = 'block';
                document.getElementById('login-status-text').textContent = 'Scan QR Code to Login';
            } else {
                document.getElementById('login-status-text').textContent = 'Could not fetch QR (Browser might be logged in or starting)';
            }
        }


        // --- Scroll Logic ---
        function scrollToBottom() {
            const container = document.getElementById('messages-area');
            container.scrollTop = container.scrollHeight;
            hideScrollBtn();
        }

        function showScrollBtn() {
            const btn = document.getElementById('scroll-btn');
            if (btn) btn.style.display = 'flex';
        }

        function hideScrollBtn() {
            const btn = document.getElementById('scroll-btn');
            if (btn) btn.style.display = 'none';
        }

        function handleScroll() {
            const container = document.getElementById('messages-area');
            const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            if (isAtBottom) {
                hideScrollBtn();
            } else {
                showScrollBtn();
            }
        }

        // --- Scanner Logic ---
        async function scanChat() {
            const input = document.getElementById('scan-input');
            const link = input.value.trim();
            if (!link) return alert('Enter a link');

            // Find button by text content roughly or structure
            const btn = input.nextElementSibling;
            btn.textContent = 'Scanning...';
            btn.disabled = true;

            try {
                const res = await fetch('/scan-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatLink: link, limit: 100 })
                });
                const leads = await res.json();

                if (leads.error) throw new Error(leads.error);

                const container = document.getElementById('scan-list');
                container.innerHTML = '';
                document.getElementById('scan-results').style.display = 'block';

                if (leads.length === 0) {
                    container.innerHTML = '<div style="color:var(--text-secondary);">No keywords found in last 100 messages.</div>';
                }

                leads.forEach((lead, index) => {
                    const div = document.createElement('div');
                    div.style.padding = '0.75rem';
                    div.style.border = '1px solid var(--border)';
                    div.style.borderRadius = '0.5rem';
                    div.style.background = 'var(--bg-main)';
                    div.style.marginBottom = '0.5rem';

                    const name = lead.sender.firstName || 'Unknown';
                    const username = lead.sender.username ? `@${lead.sender.username}` : 'No username';

                    // Robust escaping
                    const safeText = lead.text
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '&quot;')
                        .replace(/\n/g, ' ');

                    const safeName = name
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\'");

                    const safeUsername = (lead.sender.username || lead.sender.id).toString();

                    const isLong = lead.text.length > 100;
                    const shortText = isLong ? lead.text.substring(0, 100) + '...' : lead.text;
                    // Escape for HTML display
                    const safeAccessHash = (lead.sender.accessHash || '');

                    const displayFull = lead.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const displayShort = shortText.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div style="flex:1; margin-right:1rem;">
                                <div style="font-weight:600;">${name} <span style="font-size:0.8rem; color:var(--text-secondary);">${username}</span></div>
                                
                                <div id="scan-text-${index}" style="margin-top:0.25rem; font-size:0.9rem; white-space: pre-wrap;">${displayShort}</div>
                                ${isLong ? `<a href="#" onclick="event.preventDefault(); toggleScanText(${index}, '${displayFull.replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${displayShort.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" id="scan-toggle-${index}" style="font-size:0.8rem; color:var(--primary);">Read more</a>` : ''}
                            </div>
                            <button class="btn btn-primary" style="font-size:0.7rem; white-space:nowrap;" onclick="startScoutedDialogue('${safeUsername}', '${safeName}', '${safeText.substring(0, 50)}', '${safeAccessHash}')">
                                Chat
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });

            } catch (e) {
                alert('Scan failed: ' + e.message);
            } finally {
                btn.textContent = 'Scan';
                btn.disabled = false;
            }
        }

        async function startScoutedDialogue(usernameId, name, contextText, accessHash) {
            try {
                const res = await fetch('/scout/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: usernameId,
                        name: name,
                        context: contextText,
                        accessHash: accessHash || undefined
                    })
                });
                const data = await res.json();
                if (data.dialogueId) {
                    loadDialogues(); // Refresh sidebar
                    setTimeout(() => selectChat(data.dialogueId), 500); // Open chat
                }
            } catch (e) {
                alert('Failed to start chat');
            }
        }

        // --- Prompt / Rules Logic ---
        let promptDialogueId = null;

        function openPromptModal(id, targetText = null) {
            promptDialogueId = id;
            document.getElementById('prompt-input').value = '';
            document.getElementById('prompt-save-rule').checked = false; // Reset checkbox

            const targetContainer = document.getElementById('prompt-target-container');
            const targetEl = document.getElementById('prompt-target-text');

            if (targetText) {
                targetContainer.style.display = 'block';
                targetEl.textContent = targetText;
            } else {
                targetContainer.style.display = 'none';
            }

            document.getElementById('prompt-modal').style.display = 'flex';
            document.getElementById('prompt-input').focus();
        }

        function closePromptModal() {
            document.getElementById('prompt-modal').style.display = 'none';
            promptDialogueId = null;
        }

        async function submitPrompt() {
            const instructions = document.getElementById('prompt-input').value;
            const saveAsRule = document.getElementById('prompt-save-rule').checked;

            if (!instructions) return;

            const btn = document.querySelector('#prompt-modal .btn-primary');
            const originalText = btn.textContent;
            btn.textContent = 'Generating...';
            btn.disabled = true;

            try {
                // 1. Generate
                const res = await fetch(`/dialogues/${promptDialogueId}/regenerate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instructions })
                });

                // 2. Save Rule if checked
                if (saveAsRule) {
                    await fetch('/rules', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content: instructions,
                            isGlobal: false,
                            userId: dialogues.find(d => d.id === promptDialogueId)?.user?.id // Need user ID
                        })
                    });
                }

                if (res.ok) {
                    closePromptModal();
                    selectChat(promptDialogueId);
                } else {
                    const err = await res.json();
                    alert('Failed: ' + (err.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // --- Rules Logic ---
        async function loadRules() {
            try {
                const res = await fetch('/rules');
                const rules = await res.json();
                renderRules(rules);
            } catch (e) {
                console.error("Failed to load rules", e);
            }
        }

        function renderRules(rules) {
            const container = document.getElementById('rules-list');
            container.innerHTML = '';

            if (rules.length === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center;">No rules found.</div>';
                return;
            }

            rules.forEach(r => {
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';

                const typeBadge = r.isGlobal
                    ? '<span class="badge" style="background:#8e44ad;">GLOBAL</span>'
                    : '<span class="badge" style="background:#f39c12;">USER</span>';

                div.innerHTML = `
                    <div>
                        <div style="margin-bottom:0.5rem;">${typeBadge} <span style="font-size:0.8rem; color:var(--text-secondary);">${new Date(r.createdAt).toLocaleDateString()}</span></div>
                        <div style="font-size:1rem;">${r.content}</div>
                        ${r.userId ? `<div style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.2rem;">User ID: ${r.userId}</div>` : ''}
                    </div>
                    <button class="btn" style="color:var(--danger);" onclick="deleteRule(${r.id})"><ion-icon name="trash-outline"></ion-icon></button>
                `;
                container.appendChild(div);
            });
        }

        async function deleteRule(id) {
            if (!confirm('Delete this rule?')) return;
            try {
                await fetch(`/rules/${id}`, { method: 'DELETE' });
                loadRules();
            } catch (e) { alert('Failed to delete rule'); }
        }

        // --- Init ---
        // Load initial data
        refreshStats();
        loadTemplates();

        // Add hook to switchView for Rules
        const originalSwitchView = switchView;
        switchView = (viewId) => {
            // Hide all views
            document.querySelectorAll('.view-container, #inbox-view').forEach(el => {
                el.classList.remove('active');
                if (el.id === 'inbox-view') el.style.display = 'none';
            });

            // Show selected view
            const target = document.getElementById(viewId + '-view');
            if (viewId === 'inbox') {
                target.style.display = 'flex';
                loadDialogues();
            } else if (viewId === 'rules') {
                loadRules();
            }
            target.classList.add('active');

            // Update Nav link
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const navLink = document.querySelector(`.nav-link[onclick="switchView('${viewId}')"]`);
            if (navLink) navLink.classList.add('active');
        };

    </script>

    <!-- Prompt Modal -->
    <div id="prompt-modal" class="modal-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="background:var(--bg-card); padding:2rem; border-radius:12px; width:500px; border:1px solid var(--border);">
            <h3>Regeneration Rules üß†</h3>

            <div id="prompt-target-container"
                style="margin-bottom:1rem; padding:0.5rem; background:var(--bg-secondary); border-left: 3px solid var(--primary); border-radius:4px; display:none;">
                <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.25rem;">Refining message:
                </div>
                <div id="prompt-target-text"
                    style="font-size:0.9rem; font-style:italic; max-height:100px; overflow-y:auto;"></div>
            </div>

            <p style="color:var(--text-secondary); margin-bottom:1rem;">Give specific instructions to the AI for this
                reply (e.g., "Be more casual", "Ask about budget").</p>
            <textarea id="prompt-input" rows="4"
                style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid var(--border); background:var(--bg-main); color:var(--text-main); margin-bottom:1rem;"
                placeholder="Enter instructions..."></textarea>

            <div style="margin-bottom:1rem; display:flex; align-items:center;">
                <input type="checkbox" id="prompt-save-rule" style="margin-right:0.5rem;">
                <label for="prompt-save-rule"
                    style="color:var(--text-secondary); font-size:0.9rem; cursor:pointer;">Save as <strong>Rule</strong>
                    for this client</label>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                <button class="btn btn-secondary" onclick="closePromptModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitPrompt()">Regenerate with Rules</button>
            </div>
        </div>
    </div>
</body>
</div>
</body>

</html>